<!DOCTYPE html>
<html lang="zh">
<head>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$','$']],  // 行内公式符号
                displayMath: [['\\[', '\\]'], ['$$','$$']], // 块级公式符号
                processEscapes: false,           // 允许转义字符
                scale: 0.8                  // 缩放比例
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] // 跳过代码块⚡
            },
            svg: {
                styles: {
                    '.MathJax_SVG': {
                        'z-index': '1 !important',  // 预埋样式
                    }
                }
            }
        };
    </script>
    <meta charset="UTF-8">
    <title>教师助手</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <link href="{{ url_for('prism', filename='prism.css') }}" rel="stylesheet" />

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            background-color: #f8f9fa;
        }

        /* 完整代码块样式示例 */
        code {
            font-size: 1rem;           /* 相对单位更灵活 */
            padding: 0.2em 0.4em;         /* 内边距 */
            background: #f5f7f9;          /* 背景色 */
            font-family: 'Courier New', monospace;
        }

        /* 代码块容器样式 */
        pre > code {
            font-size: 14px;
            display: block;
            overflow-x: auto;
            padding: 1em;
            line-height: 1.5;
        }

        /* 模型思考高亮样式 */
        think {
            display: inline-block;
            color: #666;
            font-size: 12px;
            font-family: Arial;
            width: 100%;
            white-space: pre-line;
            line-height: 1;
        }

        global-memory {
            display: inline-block;
            background-color: #80beff;  /* 灰色背景 */
            color: black;               /* 黑色字体 */
            font-size: 15px;            /* 较小字号 */
            padding: 10px 12px;           /* 内边距 */
            border-radius: 4px;         /* 可选：圆角 */
          }

          /* 添加默认前缀 */
          global-memory::before {
            content: "记忆已添加：";
            font-weight: bold;
          }

        /* 设置欢迎页面的样式 */
        #welcome-page {
            position: relative; /* 相对定位，用于内部元素定位 */
            height: 90vh; /* 占满整个视口高度 */
            display: flex;
            flex-direction: column; /* 垂直排列子元素 */
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow: hidden; /* 防止图片溢出 */
        }

        /* 图片元素样式 */
        #welcome-page img {
            position: absolute; /* 绝对定位，覆盖整个容器 */
            top: 0;
            left: 0;
            width: 100%; /* 宽度占满容器 */
            height: 100%; /* 高度占满容器 */
            object-fit: cover; /* 保持图片比例，覆盖整个区域 */
            z-index: 1; /* 图片在底层 */
        }

        /* 文字样式 */
        #welcome-page h1 {
            position: relative; /* 相对定位，确保在图片上方 */
            z-index: 2; /* 文字在图片上层 */
            font-size: 43px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5); /* 半透明背景 */
            border-radius: 10px;
            margin-bottom: 20px; /* 增加标题和按钮之间的间距 */
        }

        /* 按钮容器 */
        .mode-button-container {
            position: relative; /* 相对定位，确保在图片上方 */
            width: 300px;
            z-index: 2; /* 按钮在图片上层 */
            display: flex; /* 使用 flex 布局让按钮并排 */
            gap: 10px; /* 按钮之间的间距 */
        }

        /* 按钮样式 */
        #welcome-page #voice-mode-button,
        #welcome-page #text-mode-button {
            padding: 10px 20px; /* 按钮内边距 */
            width: 100%;
            font-size: 20px; /* 按钮字体大小 */
            cursor: pointer; /* 鼠标悬停时显示手型 */
            border-radius: 10px;
            background-color: #c3e0ff;
        }

        /* 侧边栏基础样式 */
        #sidebar {
            width: 250px;
            background-color: #ffffff;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: width 0.1s ease; /* 添加过渡效果 */
        }

        /* 折叠状态 */
        #sidebar.collapsed {
            width: 100px; /* 折叠后的宽度 */
            overflow: hidden; /* 隐藏内容 */
        }

        /* 折叠按钮样式 */
        #toggle-sidebar {
            align-self: flex-end; /* 按钮靠右 */
            margin-bottom: 10px; /* 调整按钮位置 */
            font-size: 30px;
            background-color: #ffffff;
            border: none;
        }

        #toggle-sidebar:hover {
            background-color: #f0f0f0; /* 鼠标悬停时的背景色 */
        }

        .sidebar-footer {
            position: relative;
            margin-top: auto; /* 将内容推到最底部 */
            padding-top: 20px;
        }

        #settings-button {
            position: absolute;
            right: 10px;
            bottom: 5px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* 设置模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000; /* 确保模态窗口在最上层 */
            justify-content: center;
            align-items: center;
        }


        .modal-content {
            width: 600px; /* 设置宽度 */
            height: 480px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            position: relative;
            overflow: auto; /* 内容溢出时显示滚动条 */
        }

        .memory-model {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; /* 确保模态窗口在最上层 */
            justify-content: center;
            align-items: center;
        }

        .memory-content {
            width: 600px; /* 设置宽度 */
            max-width: 80%;
            position: relative;
            overflow-y: auto; /* 内容溢出时显示滚动条 */
        }

        #memory-button {
            padding: 10px;
            right: 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #add-memory-button
        {
            padding: 10px;
            background-color: #ffffff;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #add-memory-button:hover {
            background-color: #f0f0f0;
        }

        .add-memory-modal {
            display: none;
            position: fixed;  /* 改为固定定位 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);  /* 精准居中 */
            width: 550px;  /* 固定宽度 */
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2001;
        }

        #add-memory-text {
            width: 500px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        #add-memory-send-button {
            display: block;
            width: 60px;
            padding: 8px;  /* 减小按钮尺寸 */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;  /* 调小字体 */
            transition: background 0.2s;
        }

        #add-memory-send-button:hover {
            background-color: #0056b3;  /* 加深悬停色 */
        }

        #memory-template {
            display: none;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .memory-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .delete-memory-button {
            background: #f0f0f0;
            border: #007bff 1px solid;
            color: #dc3545;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            transition: opacity 0.2s;
        }

        .delete-memory-button:hover {
            opacity: 0.8;
        }

        .file-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; /* 确保模态窗口在最上层 */
            justify-content: center;
            align-items: center;
        }

        .file-content {
            width: 600px; /* 设置宽度 */
            max-width: 80%;
            position: relative;
            overflow-y: auto; /* 内容溢出时显示滚动条 */
        }

        #file-button {
            padding: 10px;
            right: 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .file-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .delete-file-button {
            background: #f0f0f0;
            border: #007bff 1px solid;
            color: #dc3545;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            transition: opacity 0.2s;
        }

        .form-group {
            margin: 10px;
            display: flex; /* 启用 Flexbox 布局 */
            align-items: center; /* 垂直居中对齐 */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input[type="range"] {
            width: 150px;
            height: 15px;
            margin-left: auto; /* 靠右对齐 */
        }

        /* 保存按钮样式 */
        #settings-form button[type="submit"] {
            position: absolute; /* 绝对定位 */
            bottom: 20px; /* 距离底部 20px */
            right: 20px; /* 距离右侧 20px */
            padding: 10px 20px; /* 内边距 */
            border: none; /* 去掉边框 */
            background-color: #007bff; /* 背景颜色 */
            color: white; /* 文字颜色 */
            border-radius: 20px; /* 圆角 */
            cursor: pointer; /* 鼠标指针样式 */
        }

        /* 保存按钮悬停效果 */
        #settings-form button[type="submit"]:hover {
            background-color: #0056b3; /* 悬停时背景颜色 */
        }

        /* 开关容器 */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* 隐藏默认的 checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* 滑块 */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 25px;
            width: 50px;
            height: 25px;
        }

        /* 滑块圆形部分 */
        .slider:before {
            position: absolute;
            content: "";
            height: 21px;
            width: 21px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        /* 当开关打开时的样式 */
        input:checked + .slider {
            background-color: #2196F3; /* 蓝色 */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* 模式选择按钮 */
        #new-chat-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #new-chat-button:hover,
        #voice-mode-button:hover,
        #text-mode-button:hover {
            background-color: #0056b3;
        }

        #chat-history-container {
            margin-top: 20px;
            max-height: 250px; /* 限制最大高度 */
            overflow-y: auto; /* 超出部分滚动 */
        }

        .chat-button {
            position: relative;
            display: flex;
            width: 100%;
            padding: 10px;
            border: none;
            background-color: #ffffff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .chat-title {
            display: inline-block;
            width: calc(100% - 30px); /* 留出删除按钮的空间 */
            overflow: hidden;
            text-overflow: ellipsis; /* 超出部分用省略号表示 */
            white-space: nowrap; /* 不换行 */
        }

        .delete-chat-button {
            position: absolute;
            right: 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            visibility: hidden;
        }

        .chat-button:hover {
            background-color: #f0f0f0;
        }

        .chat-button:hover .delete-chat-button {
            opacity: 1;
            visibility: visible;
        }

        .delete-chat-button:hover {
            transform: scale(1.2);
        }

        /* 主区域 */
        #chat-container {
            flex: 1;
            position: relative;
            padding: 10px 10px 80px;
            border: none;
            background-color: white;
            overflow-y: auto;
        }
        /* 隐藏滚动条 */
        #chat-container::-webkit-scrollbar {
            width: 0; /* 隐藏横向滚动条 */
            height: 0; /* 隐藏纵向滚动条 */
        }

        #chat-content-container {

            top: 0;
            bottom: 0;
            position: relative;
            overflow-y: auto;
            background-color: white;
            border: none;
            max-width: 1200px; /* Ajustez cette valeur selon vos besoins */
            margin: 0 auto; /* Centre le conteneur horizontalement */
        }

        /* 隐藏滚动条 */
        #chat-content-container::-webkit-scrollbar {
            width: 0; /* 隐藏横向滚动条 */
            height: 0; /* 隐藏纵向滚动条 */
        }

        .pb {
            position: fixed;
            height: 150px;
            border: none;
            display: block;
            bottom: 0; /* 定位到容器底部 */
            width: 100%; /* 使元素宽度与容器一致 */
            margin-top: 10px
        }

        #scroll-to-bottom {
            z-index: 2;
            position: fixed;
            top: 80px; /* 在输入框上方 */
            left: calc(50% + 100px);
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 123, 255, 0.8);
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        #scroll-to-bottom:hover {
            background: rgba(0, 86, 179, 0.9);
            transform: translateX(-50%) scale(1.1);
        }

        #scroll-to-bottom.visible {
            opacity: 1;
        }

        /* 每条聊天记录 */
        .chat-content {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: white;
        }

        .message.user-message {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .recognized-text {
            max-width: 80%;
            background-color: #e1f5fe;
            padding-left: 10px;
            padding-right: 10px;
            padding-bottom: -20px;
            padding-top: -20px;
            border-radius: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* AI 消息容器 */
        .message.ai-message {
            display: flex;
            align-items: flex-start;
            gap: 1px; /* 头像和内容之间的间距 */
            margin-top: 10px;
            margin-bottom: 50px;
            position: relative; /* 为子元素提供定位上下文 */
            padding-bottom: 20px; /* 为按钮预留空间，避免内容被按钮遮挡 */
        }

        .bottom-button-container{
            height: 100px;
            background-color: #9a6e3a;
            display: flex !important;
        }

        .copy-button {
            position: absolute; /* 绝对定位 */
            bottom: 0; /* 放在容器底部 */
            left: 50px; /* 放在容器左侧 */
            margin: 10px; /* 根据需要调整间距 */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .copy-button:hover {
            background-color: #f0f0f0; /* 鼠标悬停时的背景色 */
        }

        .copy-button {
            position: absolute; /* 绝对定位 */
            bottom: 0; /* 放在容器底部 */
            left: 50px; /* 放在容器左侧 */
            margin: 10px; /* 根据需要调整间距 */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .copy-button:hover::after {
            content: "Copy";
            position: absolute;
            top: 120%; /* 从按钮底部开始 */
            left: 50%; /* 水平居中 */
            transform: translateX(-50%); /* 水平居中 */

            padding: 5px;
            background-color: rgba(0, 0, 0, 0.7); /* 黑色半透明背景 */
            color: white; /* 文字颜色 */
            border-radius: 8px; /* 圆角 */
            opacity: 1; /* 完全显示 */
            transition: opacity 0.3s ease; /* 添加过渡效果 */
            z-index: 10; /* 确保悬浮框在最上层 */
            text-align: center; /* 文字居中 */
            font-size: 12px; /* 文字大小 */
        }

        .info-button {
            position: absolute; /* 绝对定位 */
            bottom: 0; /* 放在容器底部 */
            left: 80px; /* 放在容器左侧 */
            margin: 10px; /* 根据需要调整间距 */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .info-button:hover {
            background-color: #f0f0f0; /* 鼠标悬停时的背景色 */
        }

        .info-button:hover::after {
            content: attr(data-info); /* 从 data-info 属性中读取内容 */
            position: absolute;
            top: 120%; /* 从按钮底部开始 */
            left: 50%; /* 水平居中 */
            transform: translateX(-50%); /* 水平居中 */
            width: 150px; /* 悬浮框的宽度 */
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.7); /* 黑色半透明背景 */
            color: white; /* 文字颜色 */
            border-radius: 8px; /* 圆角 */
            opacity: 1; /* 完全显示 */
            transition: opacity 0.3s ease; /* 添加过渡效果 */
            z-index: 10; /* 确保悬浮框在最上层 */
            text-align: center; /* 文字居中 */
            font-size: 12px; /* 文字大小 */
            line-height: 1.5; /* 行高 */
        }

        .info-button::after {
            opacity: 0; /* 默认隐藏 */
            pointer-events: none; /* 防止伪元素干扰点击事件 */
        }

        #copy-feedback {
            color: green;
            margin-top: 10px;
        }

        /* AI 头像容器 */
        .profile-icon {
            width: 50px; /* 固定宽度 */
            flex-shrink: 0; /* 防止被压缩 */
        }

        /* AI 头像 */
        .profile-icon img {
            width: 35px; /* 头像大小 */
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* AI 回复内容 */
        .ai-response {
            background-color: white;
            overflow-wrap: break-word; /* 更现代的属性 */
            align-self: flex-end;
            margin: 4px 0;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.2;
        }

        /* 聊天标题 */
        #chat-header-container {
            font-size: 28px;
            margin-bottom: 20px;
        }

        #model-selector {
            width: 300px;
            padding: 10px;
            border : none;
        }

        /* 语音按钮 */
        .button-container {
            position: fixed;
            bottom: 0;
            left: 60%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 10px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        /* 文字输入框 */
        #input-container {
            position: absolute;
            bottom: 20px;       /* 与父级padding-bottom对应 */
            left: 20px;         /* 对齐父级左padding */
            right: 20px;        /* 对齐父级右padding */
            display: flex;
            gap: 8px;
            background-color: aliceblue;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        #user-input {
            flex: 1; /* 输入框占据剩余空间 */
            height: 56px; /* 初始高度 */
            min-height: 56px !important;
            max-height: 150px; /* 限制最大高度 */
            padding: 15px; /* 增加内边距 */
            font-size: 16px; /* 增大字体 */
            border: 1px solid #ccc; /* 边框 */
            border-radius: 5px; /* 圆角 */
            margin-right: 0; /* 与按钮的间距 */
            outline: none; /* 移除默认聚焦边框 */
            overflow-y: auto; /* 超出部分滚动 */
            line-height: 1.5;
        }

        .circle-button {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        #send-button,
        #upload-file-button,
        #toggle-mode-button {
            padding: 15px 30px; /* 增加按钮内边距 */
            font-size: 16px; /* 增大字体 */
            background-color: #007bff; /* 按钮背景色 */
            color: white; /* 按钮文字颜色 */
            border: none; /* 移除边框 */
            border-radius: 5px; /* 圆角 */
            cursor: pointer; /* 鼠标指针样式 */
            transition: background-color 0.3s ease; /* 平滑过渡效果 */
        }

        #send-button:hover,
        #upload-file-button:hover,
        #toggle-mode-button:hover {
            background-color: #0056b3; /* 悬停时背景色 */
        }

        /* 🕶️ 隐藏默认文件输入 */
        #file-input {
            display: none;
        }

        /* 按钮通用样式 */
        #start-button,
        #stop-button {
            width: 180px;
            height: 50px;
            border: none;
            border-radius: 25px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #start-button:hover,
        #stop-button:hover {
            background-color: #0056b3;
        }

        #stop-button:disabled,
        #start-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

    </style>

</head>
<body>
    <script src="{{ url_for('prism', filename='prism.js') }}"></script>
    <!-- 左侧边栏 -->
    <div id="sidebar">
        <!-- 折叠按钮 -->
        <button id="toggle-sidebar" class="cursor-pointer p-[7px] flex rounded-xl hover:bg-gray-100 dark:hover:bg-gray-900 transition">
            ≡
        </button>
        <div label="sidebar-content">
            <button id="new-chat-button">新聊天</button>
        </div>
        <!-- 聊天历史列表 -->
        <template id="chat-history-template">
            <span class="chat-button">
                <span class="chat-title">新聊天</span>
                <span class="delete-chat-button">❌</span>
            </span>
        </template>
        <div id="chat-history-container"></div>
        <div class="sidebar-footer">
            <button id="settings-button">⚙️</button>
            <small>© 2025 ExSLM</small>
        </div>

        <!-- 设置弹出窗口 -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>设置</h2>
                <form id="settings-form">
                    <button id="memory-button" type="button">管理记忆</button>
                    <button id="file-button" type="button">管理文件</button>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="language">语音语言:</label>
                        <select id="language" name="language">
                            <option value=0>Chinese</option>
                            <option value=1>English</option>
                            <option value=2>Japanese</option>
                            <option value=3>French</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="temperature">Temperature:</label>
                        <input type="range" id="temperature" name="temperature" min="0.1" max="1" value="0.1" step="0.1">
                        <p><span id="temperatureValue">1.0</span></p>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="audio">使用音频:</label>
                        <label class="switch">
                            <input type="checkbox" id="audio">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="use_RAG">使用RAG（需重新加载模型）:</label>
                        <label class="switch">
                            <input type="checkbox" id="use_RAG">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="embedding_model">嵌入模型（每次切换需要加载）:</label>
                        <select id="embedding_model" name="embedding_model">
                            <option value=0>BAAI/bge-reranker-base</option>
                            <option value=1>dunzhang/stella_en_400M_v5</option>
                        </select>
                    </div>
                    <button type="submit">保存</button>
                </form>
            </div>

        </div>

        <template id="memory-template">
            <div class="memory-item">
                <span class="memory-content"></span>
                <button class="delete-memory-button">删除</button>
            </div>
        </template>

        <div id="memory-window" class="memory-model">
            <div id="memory-modal-content" class="modal-content">
                <span class="close-button">&times;</span>
                <h3>记忆管理</h3>
                <button id="add-memory-button">添加记忆</button>
                <!-- 添加记忆项容器 -->
                <div id="memories-container"></div>
            </div>
        </div>

        <div id="add-memory-window" class="add-memory-modal">
            <textarea
                id="add-memory-text"
                placeholder="请输入要添加的记忆内容..."
            ></textarea>
            <button id="add-memory-send-button">添加</button>
        </div>

        <!-- 管理文件窗口 -->
        <template id="file-template">
            <div class="file-item">
                <span class="file-content"></span>
                <button class="delete-file-button">删除</button>
            </div>
        </template>

        <div id="file-window" class="file-modal">
            <div id="file-modal-content" class="modal-content">
                <span class="close-button">&times;</span>
                <h3>已上传文件</h3>
                <div id="files-container"></div>
            </div>
        </div>
    </div>

    <!-- 主对话界面 -->
    <div id="chat-container">

        <!-- 欢迎页面 -->
        <div id="welcome-page">
            <h1>欢迎使用ExSLM智能教师助手</h1>
            <img src="{{ url_for('static', filename='images/siyuanhu.jpg') }}" alt="欢迎背景图">
            <div class="mode-button-container">
                <button id="voice-mode-button">语音模式</button>
                <button id="text-mode-button">文字模式</button>
            </div>
        </div>

        <!-- 识别界面（默认隐藏） -->
        <div id="recognition-interface" style="display: none;">
            <div id="chat-header-container">
                <strong>ExSLM</strong>
                <select id="model-selector">anthropic.claude-3-sonnet-20240229-v1:0
                    <option value=0>anthropic.claude-3-sonnet-20240229-v1:0</option>
                    <option value=1>meta.llama3-70b-instruct-v1</option>
                    <option value=2>amazon.titan-text-express-v1</option>
                    <option value=3>暂无</option>
                </select>
                <div id="embedding-model-state" style="font-size: medium; color: #666; text-align: right; margin-left: auto; display: block;"></div>
            </div>

            <!-- 文字模式容器 -->
            <div id="text-mode">
                <button id="scroll-to-bottom" onclick="smartScroll()">↓</button>
                <div id="input-container">
                    <label for="user-input"></label><textarea id="user-input" placeholder="请输入您的消息..." ></textarea>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button id="send-button" class="circle-button">➤</button>
                        <button id="upload-file-button" class="circle-button" onclick="handleUpload()">✉</button>
                        <button id="toggle-mode-button" class="circle-button">️🎙️</button>
                    </div>
                </div>
                <input type="file" id="file-input" onchange="uploadFile()">
            </div>

            <!-- 语音模式容器 -->
            <div id="voice-mode" style="display: none;">
                <!-- 语音输入按钮 -->
                <div class="button-container">
                    <button id="start-button">🎙️ 开始语音输入</button>
                    <button id="stop-button" disabled>🎙 结束语音 </button>
                </div>
            </div>

            <template id="chat-template">
                <div class="chat-content">
                    <div class="message user-message">
                        <p class="recognized-text">用户：等待输入...</p>
                    </div>
                    <div class="message ai-message">
                        <div class="profile-icon">
                            <img src="{{ url_for('static', filename='images/Beef.jpg')}}">
                        </div>
                        <div class="message-content">
                            <p class="ai-response">AI 回复：等待中...</p>
                        </div>
                        <div class="bottom-button-container">
                            <button class="copy-button">📋</button>
                            <button class="info-button">ℹ️</button>
                        </div>
                        <p id="copy-feedback" style="display: none;">已复制到剪贴板！</p>
                    </div>
                </div>
            </template>

            <div id="chat-content-container">

            </div>
        </div>
    </div>


    <!-- SocketIO 通信 -->
    <script>
        var socket = io.connect("http://" + document.domain + ":" + location.port);

        MathJax.options.ignoreHtmlClass = 'scroll-lock';

        // 获取 DOM 元素
        const welcomePage = document.getElementById("welcome-page");
        const recognitionInterface = document.getElementById("recognition-interface");
        const voiceModeButton = document.getElementById("voice-mode-button");
        const textModeButton = document.getElementById("text-mode-button");
        const voiceMode = document.getElementById("voice-mode");
        const textMode = document.getElementById("text-mode");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");
        const inputContainer = document.getElementById("input-container");
        const settingsButton = document.getElementById('settings-button');
        const modal = document.getElementById('settings-modal');
        const memoryModal = document.getElementById('memory-window');
        const fileModal = document.getElementById('file-window');
        const closeButton = document.querySelector('#settings-modal .close-button');
        const memoryCloseButton = document.querySelector('#memory-window .close-button');
        const fileCloseButton = document.querySelector('#file-window .close-button');
        welcomePage.style.backgroundImage = "url('{{ url_for('static', filename='images/welcome-bg.jpg') }}')";
        const audioToggle = document.getElementById('audio');
        let outputting, interrupted;
        const language = document.getElementById('language');
        const chatContainer = document.getElementById('chat-content-container');
        const modelSelector = document.getElementById('model-selector');
        let currentChat = []; // 当前聊天记录
        const memoryButton = document.getElementById('memory-button');
        const addMemoryButton = document.getElementById('add-memory-button');
        const fileButton = document.getElementById('file-button');
        const addFileButton = document.getElementById('add-File-button');
        const newChatButton = document.getElementById('new-chat-button');
        const chatHistoryContainer = document.getElementById('chat-history-container');

        // 初始化设置
        socket.emit('start_settings_init');
        socket.emit('clear_uploads');
        socket.emit('global_memory_init');
        socket.emit('chat_list_init');

        socket.on("settings_init", (data) => {
            // 初始化设置
            const temperature = data.temperature;
            const audio_state = data.audio;
            const lang = data.language;
            const embedding_model = data.embedding_model;
            const use_RAG = data.use_RAG;
            document.getElementById('temperature').value = temperature;
            document.getElementById('temperatureValue').textContent = temperature;
            audioToggle.checked = audio_state;
            document.getElementById('use_RAG').checked = use_RAG;
            document.getElementById('embedding_model').value = embedding_model;
            language.value = lang;

            socket.emit('RAG_refresh');
        });

        // 侧边栏折叠功能
        document.getElementById('toggle-sidebar').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed'); // 切换折叠状态

            if (sidebar.classList.contains('collapsed')) {
                newChatButton.innerHTML = '💬'

                settingsButton.style.display = 'none';
            } else {
                // 等待0.5秒
                setTimeout(() => {
                    newChatButton.innerHTML = '新聊天'
                    settingsButton.style.display = 'block';
                }, 50);
            }
        });

        // 首页按钮
        socket.on("back_to_home", () => {
            welcomePage.style.display = "block";        // 显示欢迎页面
            recognitionInterface.style.display = "none"; // 隐藏识别界面
            voiceMode.style.display = "none";         // 隐藏语音模式
            textMode.style.display = "none";           // 隐藏文字模式
            welcomePage.style.cssText = "";             // 清除内联样式
            welcomePage.classList.remove("modified-class"); // 移除可能修改的类
            welcomePage.classList.add("initial-class"); // 添加初始类
        });

        // 窗口大小动态调整
        // 动态设置高度的函数
        function setChatHeight() {
            const viewportHeight = window.innerHeight;
            chatContainer.style.height = `${viewportHeight - 180}px`;
        }

        // 初始化设置
        document.addEventListener('DOMContentLoaded', setChatHeight);

        // 兼容移动端键盘弹出
        window.addEventListener('orientationchange', setChatHeight);

        function adjustWidth() {
            // 实时计算宽度
            const containerWidth = chatContainer.offsetWidth;
            inputContainer.style.width = `${containerWidth - 500}px`;
        }

        // 初始化执行
        window.addEventListener('DOMContentLoaded', adjustWidth);
        // 窗口变化监听
        window.addEventListener('resize', () => {
            // 防抖处理（500ms间隔）
            clearTimeout(window.resizeTimer);
            ScrollManager.adjustButtonPosition();
            // requestAnimationFrame(adjustWidth);
            window.resizeTimer = setTimeout(setChatHeight, 500);

        });

        // 选择模型
        document.getElementById('model-selector').addEventListener('change', () => {
            const currentModel = modelSelector.value;
            socket.emit('current_model_index', currentModel);
            console.log(currentModel);
        })

        // RAG状态
        const ragState = document.getElementById('embedding-model-state');
        socket.on("RAG_loading", () => {
            ragState.textContent = `RAG 正在加载中...`;
        });

        socket.on("RAG_loaded", () => {
            ragState.textContent = `RAG 已就绪`;
        });

        socket.on("RAG_loading_failed", (e) => {
            ragState.textContent = `RAG 加载失败: ${e}`;
        });

        socket.on("RAG_unavailable", () => {
            ragState.textContent = `RAG 未开启`;
        });

        // 设置窗口
        document.addEventListener('DOMContentLoaded', function() {

            // 打开模态窗口的函数
            function openModal() {
                modal.style.display = 'flex';
            }

            // 关闭模态窗口的函数
            function closeModal() {
                modal.style.display = 'none';
            }

            // 点击设置按钮打开模态窗口
            settingsButton.addEventListener('click', openModal);

            // 点击关闭按钮关闭模态窗口
            closeButton.addEventListener('click', function(e) {
                e.preventDefault();
                // console.log('Event details:', e);
                closeModal();
            });

            // 监听滑动条行为并更新显示的温度值
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperatureValue');
            temperatureSlider.addEventListener('input', () => {
                temperatureValue.textContent = temperatureSlider.value;
            });

            // 处理表单提交
            document.getElementById('settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('设置已保存')
                // 向后端发送设置
                const temperature = temperatureSlider.value;
                const use_RAG = document.getElementById('use_RAG').checked;
                const embedding_model = document.getElementById('embedding_model').value;
                const state = audioToggle.checked;
                const lang = language.value;
                socket.emit('update_settings', { temperature: temperature, audio_state: state, language: lang, use_RAG: use_RAG, embedding_model: embedding_model });

                socket.emit('RAG_refresh');
                closeModal();
            });

            // 监听后端返回的保存成功事件
            socket.on('temperature-saved', (data) => {
                console.log('Temperature saved:', data);
            });
        });

        // 设置中的记忆
        document.addEventListener('DOMContentLoaded', function() {
            // 打开模态窗口的函数
            function openMemoryModal() {
                memoryModal.style.display = 'flex';
            }

            // 关闭模态窗口的函数
            function closeMemoryModal() {
                memoryModal.style.display = 'none';
            }

            // 点击设置按钮打开模态窗口
            memoryButton.addEventListener('click', openMemoryModal);

            // 点击关闭按钮关闭模态窗口
            memoryCloseButton.addEventListener('click', function(e) {
                e.preventDefault();
                // console.log('Event details:', e);
                closeMemoryModal();
            });

            socket.on("global_memory_refresh", (memoriesArray) => {
                const memoriesContainer = document.getElementById("memories-container");
                // 清空现有内容避免重复
                memoriesContainer.innerHTML = '';

                console.log(memoriesArray);

                // 遍历所有记忆条目
                memoriesArray.forEach(memoryObj => {
                    const memoryTemplate = document.getElementById("memory-template").content.cloneNode(true);
                    const deleteButton = memoryTemplate.querySelector(".delete-memory-button");
                    const memoryItem = memoryTemplate.querySelector(".memory-content");

                    // 显示索引和内容（假设memoryObj.memories是字符串）
                    memoryItem.innerHTML = `[${memoryObj.index + 1}] ${memoryObj.memory}`;

                    // 为删除按钮绑定索引
                    deleteButton.dataset.index = memoryObj.index; // 存储原始索引
                    deleteButton.onclick = function() {
                        socket.emit("remove_memory", this.dataset.index);
                    };

                    memoriesContainer.appendChild(memoryTemplate);
                });
            });

            addMemoryButton.addEventListener('click', () => {
                const addMemoryWindow = document.getElementById('add-memory-window');
                addMemoryWindow.style.display = 'flex';
            });

            const addMemorySendButton = document.getElementById('add-memory-send-button');
            const addMemoryText = document.getElementById('add-memory-text');
            addMemorySendButton.addEventListener('click', () => {
                const memoryText = addMemoryText.value.trim();
                if (memoryText) {
                    socket.emit("add_memory", memoryText);
                    addMemoryText.value = ''; // 清空输入框
                    const addMemoryWindow = document.getElementById('add-memory-window');
                    addMemoryWindow.style.display = 'none';
                }
            });
        });

        // 设置中的文件
        document.addEventListener('DOMContentLoaded', function() {
            // 打开模态窗口的函数
            function openFileModal() {
                fileModal.style.display = 'flex';
            }

            // 关闭模态窗口的函数
            function closeFileModal() {
                fileModal.style.display = 'none';
            }

            // 点击设置按钮打开模态窗口
            fileButton.addEventListener('click', openFileModal);

            // 点击关闭按钮关闭模态窗口
            fileCloseButton.addEventListener('click', function(e) {
                e.preventDefault();
                closeFileModal();
            });

            socket.on('upload_files', (data) => {
                // 读取 doc_list
                const docList = data.doc_list;
                console.log("Received doc_list:", docList);

                if (docList.length > 5){
                    alert("超出可上传文件上限，仅保留最近五则！如需取消上传，请前往 设置-管理文件 删除相应文件。");
                }

                // 读取 using_doc_list
                const usingDocList = data.using_doc_list;
                console.log("Received using_doc_list:", usingDocList);

                const filesContainer = document.getElementById("files-container");
                // 清空现有内容避免重复
                filesContainer.innerHTML = '';

                // 处理列表内容
                docList.forEach((fileName, index) => {
                    console.log(`Document ${index + 1}: ${fileName}`);
                    const fileTemplate = document.getElementById("file-template").content.cloneNode(true);
                    const deleteButton = fileTemplate.querySelector(".delete-file-button");
                    const fileItem = fileTemplate.querySelector(".file-content");

                    // 显示索引和内容
                    fileItem.innerHTML = `[${index + 1}] ${fileName}`;

                    // 为删除按钮绑定索引
                    deleteButton.dataset.index = index; // 存储原始索引
                    console.log(deleteButton.dataset.index);
                    deleteButton.onclick = function() {
                        socket.emit("remove_file", this.dataset.index);
                    };

                    filesContainer.appendChild(fileTemplate);
                });

                usingDocList.forEach((fileName, index) => {
                    console.log(`Using Document ${index + 1}: ${fileName}`);
                })

            })

        });

        // 删除聊天记录，恢复窗口
        socket.on("new_chat_window", () => {
            chatContainer.innerHTML = '';
        });

        // 刷新聊天栏
        socket.on("refresh_chat_list", (data) => {
            chatHistoryContainer.innerHTML = '';

            data.forEach((item) => {
                const chatTemplate = document.getElementById("chat-history-template").content.cloneNode(true);
                const chatButton = chatTemplate.querySelector(".chat-button");
                const chatTitle = chatTemplate.querySelector(".chat-title");
                const deleteButton = chatTemplate.querySelector(".delete-chat-button");

                // 设置聊天标题和删除按钮
                deleteButton.dataset.index = item.index; // 存储原始索引
                chatButton.dataset.index = item.index;
                deleteButton.onclick = function() {
                    socket.emit("delete_chat", this.dataset.index);
                };

                chatTitle.textContent = `聊天 ${item.index + 1}`;

                // 点击聊天按钮加载聊天记录
                chatButton.onclick = function() {
                    socket.emit("choose_chat", this.dataset.index);
                    welcomePage.style.display = "none";        // 隐藏欢迎页面
                    recognitionInterface.style.display = "block"; // 显示识别界面
                    voiceMode.style.display = "none";         // 隐藏语音模式
                    textMode.style.display = "block";          // 显示文字模式
                };

                if (item.stress === true)
                    chatButton.style.backgroundColor = "#f0f0f0";

                chatHistoryContainer.appendChild(chatTemplate);
            });
        });

        // 新聊天
        newChatButton.addEventListener("click", () => {
            textarea.style.height = '57px'; // 初始高度
            welcomePage.style.display = "none";        // 隐藏欢迎页面
            recognitionInterface.style.display = "block"; // 显示识别界面
            textMode.style.display = "block";          // 显示文字模式
            voiceMode.style.display = "none";          // 隐藏语音模式
            socket.emit("new_chat"); // 新聊天
        });

        // 语音模式
        voiceModeButton.addEventListener("click", () => {
            welcomePage.style.display = "none";        // 隐藏欢迎页面
            recognitionInterface.style.display = "block"; // 显示识别界面
            voiceMode.style.display = "block";         // 显示语音模式
            textMode.style.display = "none";           // 隐藏文字模式
            socket.emit("new_chat"); // 新聊天
        });

        // 文字模式
        textModeButton.addEventListener("click", () => {
            textarea.style.height = '57px'; // 初始高度
            welcomePage.style.display = "none";        // 隐藏欢迎页面
            recognitionInterface.style.display = "block"; // 显示识别界面
            textMode.style.display = "block";          // 显示文字模式
            voiceMode.style.display = "none";          // 隐藏语音模式
            socket.emit("new_chat"); // 新聊天
        });

        // 文本框大小自动调整逻辑
        const textarea = document.getElementById("user-input");
        textarea.addEventListener('input', function() {
            // 重置高度，使得textarea可以缩小
			this.style.height = '40px';
			// 根据内容重新调整高度
            console.log(this.scrollHeight);
			this.style.height = this.scrollHeight + 3 + 'px';
        });

        // 发送按钮的状态切换
        const sendButtonToggle = {
            "to_send": () => {
                sendButton.innerHTML = "➤";
            },

            "to_interrupt": () => {
                sendButton.innerHTML = "■";
            }
        }

        // 发送按钮的功能
        const sendButtonActions = {
            "send": () => {
                const text = userInput.value.trim();
                if (text) {
                    socket.emit("user_text", text); // 发送用户输入到后端
                    userInput.value = ""; // 清空输入框
                    const textarea = document.getElementById("user-input");
                    textarea.style.height = '56.8px'; // 重置高度
                    sendButtonToggle["to_interrupt"](); // 切换按钮状态
                    outputting = true; // 设置输出状态

                    // 保存用户输入到当前聊天记录
                    currentChat.push({ user: text, ai: "" }); // AI 回复暂时为空
                }
            },

            "interrupt": () => {
                interrupted = true;
                socket.emit("interrupt");
                sendButtonToggle["to_send"](); // 切换按钮状态
            }
        }

        // 发送用户输入到后端或执行中断输出
        sendButton.addEventListener("click", () => {
            if (outputting) {
                sendButtonActions["interrupt"]();
            } else {
                sendButtonActions["send"]();
            }
        });

        // 发送按钮的ENTER触发
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !outputting) {
                e.preventDefault(); // 阻止默认换行
                document.getElementById('send-button').click(); // 触发按钮点击
            }
        });

        // 发送开始语音指令
        document.getElementById("start-button").onclick = function () {
            socket.emit("start_recognition");
        };

        // 发送结束语音指令
        document.getElementById("stop-button").onclick = function () {
            socket.emit("stop_recognition");
        };

        // 监听语音识别结果
        socket.on("recognized_text", (text) => {
            const chatContainer = document.getElementById("chat-content-container");
            const chatTemplate = document.getElementById("chat-template").content.cloneNode(true);
            chatTemplate.querySelector(".recognized-text").innerHTML = `${text}`;
            chatContainer.appendChild(chatTemplate);
            Prism.highlightAll();
            MathJax.typeset();
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // 隐藏的提交文件按钮
        function handleUpload() {
            // 🎯 触发隐藏的文件选择对话框
            document.getElementById('file-input').click();
        }

        // 上传文件
        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) return;

            // 📦 创建FormData对象
            const formData = new FormData();
            formData.append('file', file);

            try {
                // 🚀 使用Fetch API异步上传
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                // 🔄 清空已选文件
                fileInput.value = '';
            } catch (error) {
                alert('❌ 上传失败: ' + error.message);
            }
        }

        // 流式接收AI回复 (使用新事件名称)
        let isNewResponse = true; // 标记是否新回复开始
        socket.on("refresh_ai_response", (responseHtml) => {
            if (interrupted) return;
            const chatContainer = document.getElementById("chat-content-container");
            // 获取最新对话块
            const lastChat = chatContainer.lastElementChild;
            const aiResponseElem = lastChat.querySelector(".ai-response");

            // 增量更新内容 🚀
            aiResponseElem.innerHTML = `${responseHtml}`;

            // 动态高亮 & 数学渲染 💡
            Prism.highlightAllUnder(lastChat); // 仅处理当前块
            MathJax.typeset([aiResponseElem]); // 仅渲染当前元素

            ScrollManager.autoScroll();
            ScrollManager.checkButtonVisibility();
        });

        document.addEventListener('click', function (event) {
            if (event.target.className === "copy-button") {
                const aiResponse = event.target.getAttribute('data-ai-response');
                if (aiResponse) {
                    console.log("点击复制按钮，复制的文本:", aiResponse);
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(aiResponse)
                            .then(() => {
                                console.log("复制成功");
                                showFeedback();
                                alert('复制成功！');
                            })
                            .catch((err) => {
                                console.error('复制失败:', err);
                            });
                    } else {
                        fallbackCopy(aiResponse);
                    }
                } else {
                    console.error("未找到 AI 回复内容");
                }
            }
        });

        socket.on("retrievedInfo", (infoData) => {
            const stopReason = infoData.stopReason;
            const stopSequence = infoData.stopSequence;
            const outputTokens = infoData.outputTokens;
            console.log(stopSequence, stopSequence, outputTokens);

            // 获取 infoButton
            const infoButtons = document.getElementsByClassName("info-button");
            const infoButton = infoButtons[infoButtons.length - 1];

            // 将数据写入 infoButton 的 data-info 属性
            infoButton.setAttribute(
                "data-info",
                `Stop Reason: ${stopReason}\nStop Sequence: ${stopSequence}\nOutput Tokens: ${outputTokens}`
            );
            console.log(infoButton.attributes);
        });

        socket.on("ai_response_end", (aiResponse) => {
            interrupted = false;
            outputting = false; // 重置输出状态
            sendButtonToggle["to_send"](); // 切换按钮状态
            const copyButtons = document.getElementsByClassName("copy-button")
            const copyButton = copyButtons[copyButtons.length - 1]
            const infoButtons = document.getElementsByClassName("info-button")
            const infoButton = infoButtons[infoButtons.length - 1]
            console.log(copyButton); // 检查是否成功获取元素
            copyButton.style.display = 'block'
            infoButton.style.display = 'block';

            // 找到最新的复制按钮，并将 aiResponse 存储到其 data 属性中
            if (copyButton) {
                copyButton.setAttribute('data-ai-response', aiResponse);
            } else {
                console.error("未找到最新的复制按钮");
            }

            // 保存完整的 AI 回复到当前聊天记录
            if (currentChat.length > 0) {
                const lastMessage = currentChat[currentChat.length - 1];
                if (lastMessage.ai === "") {
                    lastMessage.ai = aiResponse; // 更新 AI 回复
                } else {
                    currentChat.push({ user: "", ai: aiResponse }); // 新增一条记录
                }
            }
        });

        // 监听生成开始事件 ⚡
        socket.on("begin_generate_response", () => {
            isNewResponse = true; // 重置标记
        });

        // 综合滚动控制模块 (v2.0)
        const scrollButton = document.getElementById('scroll-to-bottom');
        let autoScroll = true;
        let isProcessing = false;

        // 智能滚动系统 🌟
        const ScrollManager = {
            threshold: 70, // 滚动到底部的阈值
            debounceTime: 500, // 防抖时间

            init() {
                this.setupObservers();
                this.setupEventListeners();
                this.checkButtonVisibility();
            },

            setupObservers() {
                // 内容变化观察者
                new MutationObserver(mutations => {
                    if (!isProcessing) this.autoScroll();
                }).observe(chatContainer, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            },

            setupEventListeners() {
                // 整合的滚动事件监听
                let scrollTimeout;
                chatContainer.addEventListener('scroll', () => {
                    document.body.classList.add('scroll-lock');

                    this.scrollTimer = setTimeout(() => {
                        document.body.classList.remove('scroll-lock');
                    }, 500);

                    clearTimeout(scrollTimeout);
                    isProcessing = true;

                    // 判断滚动位置
                    const atBottom = this.isAtBottom();
                    autoScroll = atBottom;

                    // 更新按钮状态
                    this.checkButtonVisibility(atBottom);

                    scrollTimeout = setTimeout(() => {
                        isProcessing = false;
                        if (autoScroll) this.autoScroll();
                    }, this.debounceTime);
                });

                // 窗口大小变化响应
                window.addEventListener('resize', () => {
                    if (autoScroll) this.forceScroll();
                });
            },

            autoScroll() {
                if (autoScroll && this.isAtBottom()) {
                    requestAnimationFrame(() => {
                        chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    });
                }
            },

            forceScroll() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },

            isAtBottom() {
                return chatContainer.scrollHeight - chatContainer.scrollTop <=
                       chatContainer.clientHeight + this.threshold;
            },

            checkButtonVisibility(atBottom) {
                const shouldShow = atBottom === undefined ?
                    !this.isAtBottom() : !atBottom;

                const buttonVisible = shouldShow &&
                    (chatContainer.scrollHeight > chatContainer.clientHeight);
                scrollButton.style.opacity = buttonVisible ? '0.6' : '0';
                scrollButton.style.pointerEvents = buttonVisible ? 'auto' : 'none';
            },

            smartScroll() {
                autoScroll = true;
                this.forceScroll();
                this.checkButtonVisibility();
            },

            adjustButtonPosition() {
                const containerRect = chatContainer.getBoundingClientRect();
                const buttonBottom = containerRect.bottom - 20; // 距离底部20px
                scrollButton.style.bottom = `${buttonBottom - containerRect.top}px`;
}
        };

        // 初始化滚动系统
        ScrollManager.init();

        // 滚动按钮点击处理
        scrollButton.addEventListener('click', () => ScrollManager.smartScroll());

        // 按钮控制函数
        function toggleButton(buttonId, state) {
            const btn = document.getElementById(buttonId);
            if (btn) btn.disabled = state;
        }

        // 监听后端事件
        socket.on('toggle_button', (data) => {
            toggleButton(data.button_id, data.state);
        });

        // 📦 创建音频队列和播放状态标识
        let audioQueue = [];
        let isPlaying = false;

        // 🎧 音频播放处理器函数
        async function handleAudioPlayback(audioUrl) {
            // 1️⃣ 创建新的音频对象
            const audio = new Audio(audioUrl);

            // 🎯 播放开始处理
            audio.addEventListener('play', () => {
                isPlaying = true;
                console.log('▶️ 开始播放音频片段');
            });

            // 🏁 播放结束处理
            audio.addEventListener('ended', () => {
                console.log('⏹️ 当前音频播放完成');
                isPlaying = false;
                playNext(); // ➡️ 自动播放下一个
            });

            // 🚨 错误处理
            audio.addEventListener('error', (err) => {
                console.error('❌ 播放错误:', err);
                isPlaying = false;
                playNext(); // ➡️ 出错时继续队列
            });

            // 🎵 开始播放当前音频
            audio.play().catch(error => {
                console.error('⛔ 自动播放被阻止:', error);
                // 🖱️ 这里可以添加点击播放按钮的逻辑
            });
        }

        // ➡️ 播放下一个音频的函数
        async function playNext() {
            if (audioQueue.length > 0 && !isPlaying) {
                const nextUrl = audioQueue.shift(); // 🎚️ 取出队列第一个元素
                await handleAudioPlayback(nextUrl);
            }
        }

        // 语音模式，流式输出音频和文字
        socket.on("refresh_ai_response_with_audio", ({responseHtml, audioUrl}) => {
            if (interrupted) return;
            console.log(responseHtml);
            const chatContainer = document.getElementById("chat-content-container");
            // 获取最新对话块
            const lastChat = chatContainer.lastElementChild;
            const aiResponseElem = lastChat.querySelector(".ai-response");

            // 增量更新内容 🚀
            aiResponseElem.innerHTML = `${responseHtml}`;

            // 动态高亮 & 数学渲染 💡
            Prism.highlightAllUnder(lastChat); // 仅处理当前块
            MathJax.typeset([aiResponseElem]); // 仅渲染当前元素

            console.log('🔔 收到新的音频URL:', audioUrl);

            // 📥 将新音频加入队列
            audioQueue.push(audioUrl);

            // 🚦 如果没有正在播放，立即开始播放
            if (!isPlaying) {
                playNext();
            }

            ScrollManager.autoScroll();
            ScrollManager.checkButtonVisibility();

            // 保存 AI 回复到当前聊天记录
            if (currentChat.length > 0) {
                const lastMessage = currentChat[currentChat.length - 1];
                if (lastMessage.ai === "") { // 如果 AI 回复为空
                    lastMessage.ai = responseHtml; // 更新 AI 回复
                } else {
                    currentChat.push({ user: "", ai: responseHtml }); // 新增一条记录
                }
            }
        });

        // 播放剩余的音频
        socket.on('audio_rest', (aiResponse) => {
            console.log('播放剩余音频');

            while (!audioQueue.length > 0) {
                if (interrupted) {
                    // 清空队列
                    audioQueue = [];
                    console.log("清空音频", audioQueue);
                }
                if (!isPlaying) {
                    playNext();
                }
            }

            interrupted = false;
            outputting = false;

            sendButtonToggle["to_send"](); // 切换按钮状态
            const copyButtons = document.getElementsByClassName("copy-button")
            const copyButton = copyButtons[copyButtons.length - 1]
            const infoButtons = document.getElementsByClassName("info-button")
            const infoButton = infoButtons[infoButtons.length - 1]
            console.log(copyButton); // 检查是否成功获取元素
            copyButton.style.display = 'block'
            infoButton.style.display = 'block';

            // 找到最新的复制按钮，并将 aiResponse 存储到其 data 属性中
            if (copyButton) {
                copyButton.setAttribute('data-ai-response', aiResponse);
            } else {
                console.error("未找到最新的复制按钮");
            }
        });

        console.log("copy-button 数量:", document.querySelectorAll(".copy-button").length);

    </script>
</body>
</html>