<!DOCTYPE html>
<html lang="zh">
<head>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$','$']],  // è¡Œå†…å…¬å¼ç¬¦å·
                displayMath: [['\\[', '\\]'], ['$$','$$']], // å—çº§å…¬å¼ç¬¦å·
                processEscapes: false,           // å…è®¸è½¬ä¹‰å­—ç¬¦
                scale: 0.8                  // ç¼©æ”¾æ¯”ä¾‹
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] // è·³è¿‡ä»£ç å—âš¡
            },
            svg: {
                styles: {
                    '.MathJax_SVG': {
                        'z-index': '1 !important',  // é¢„åŸ‹æ ·å¼
                    }
                }
            }
        };
    </script>
    <meta charset="UTF-8">
    <title>æ•™å¸ˆåŠ©æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <link href="{{ url_for('prism', filename='prism.css') }}" rel="stylesheet" />
    <!-- Load Cubism and PixiJS -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/RaSan147/pixi-live2d-display@v0.5.0-ls-6/dist/index.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        /* æ–°å¢çš„è®¾ç½®çª—å£æ ·å¼ */
        #settings-modal .modal-content {
            display: flex;
            width: 800px;
            height: 600px;
            padding: 0;
            overflow: hidden;
        }

        /* å·¦ä¾§sidebaræ ·å¼ */
        .settings-sidebar {
            width: 200px;
            background-color: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            padding: 20px 0;
        }

        .settings-sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .settings-sidebar-item:hover {
            background-color: #e0e0e0;
        }

        .settings-sidebar-item.active {
            background-color: #007bff;
            color: white;
        }

        /* å³ä¾§å†…å®¹åŒºåŸŸæ ·å¼ */
        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        /* è°ƒæ•´è®°å¿†å’Œæ–‡ä»¶ç®¡ç†çª—å£æ ·å¼ */
        #memory-modal-content,
        #file-modal-content {
            width: 100%;
            height: 100%;
            box-shadow: none;
            border-radius: 0;
        }

        /* è°ƒæ•´å…³é—­æŒ‰é’®ä½ç½® */
        .settings-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        body {
            margin: 0;
            font-family: "Helvetica Neue", Arial, sans-serif;
            display: flex;
            height: 100vh;
            background-color: #f8f9fa;
        }

        /* å®Œæ•´ä»£ç å—æ ·å¼ç¤ºä¾‹ */
        code {
            font-size: 1rem;           /* ç›¸å¯¹å•ä½æ›´çµæ´» */
            padding: 0.2em 0.4em;         /* å†…è¾¹è· */
            background: #f5f7f9;          /* èƒŒæ™¯è‰² */
            font-family: 'Courier New', monospace;
        }

        /* ä»£ç å—å®¹å™¨æ ·å¼ */
        pre > code {
            font-size: 14px;
            display: block;
            overflow-x: auto;
            padding: 1em;
            line-height: 1.5;
        }

        /* æ¨¡å‹æ€è€ƒé«˜äº®æ ·å¼ */
        pre > think {
            display: block;
            color: #353535;
            font-size: 12px;
            font-family: Arial;
            width: 100%;
            white-space: pre-line;
            line-height: 1.5;
            background: #f4f4f4;
            border-radius: 8px;
            padding: 1em;
        }

        pre > think::before {
            content: "æ€è€ƒï¼š";
            line-height: 2;
            font-weight: bold;
            font-size: 120%;
            font-family: "Times New Roman";
        }

        global-memory {
            display: inline-block;
            background-color: #80beff;  /* ç°è‰²èƒŒæ™¯ */
            color: black;               /* é»‘è‰²å­—ä½“ */
            font-size: 15px;            /* è¾ƒå°å­—å· */
            padding: 10px 12px;           /* å†…è¾¹è· */
            border-radius: 4px;         /* å¯é€‰ï¼šåœ†è§’ */
          }

          /* æ·»åŠ é»˜è®¤å‰ç¼€ */
          global-memory::before {
            content: "è®°å¿†å·²æ·»åŠ ï¼š";
            font-weight: bold;
          }

        /* è®¾ç½®æ¬¢è¿é¡µé¢çš„æ ·å¼ */
        #welcome-page {
            position: relative; /* ç›¸å¯¹å®šä½ï¼Œç”¨äºå†…éƒ¨å…ƒç´ å®šä½ */
            height: 100vh; /* å æ»¡æ•´ä¸ªè§†å£é«˜åº¦ */
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—å­å…ƒç´  */
            justify-content: center;
            text-align: left;
        }

        /* å›¾ç‰‡å…ƒç´ æ ·å¼ */
        #welcome-page img {
            position: absolute; /* ç»å¯¹å®šä½ï¼Œè¦†ç›–æ•´ä¸ªå®¹å™¨ */
            top: 0;
            left: 0;
            width: 100%; /* å®½åº¦å æ»¡å®¹å™¨ */
            height: 100%; /* é«˜åº¦å æ»¡å®¹å™¨ */
            object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ï¼Œè¦†ç›–æ•´ä¸ªåŒºåŸŸ */
            z-index: 1; /* å›¾ç‰‡åœ¨åº•å±‚ */
        }

        /* æ–‡å­—æ ·å¼ */
        #welcome-page h1 {
            position: relative; /* ç›¸å¯¹å®šä½ï¼Œç¡®ä¿åœ¨å›¾ç‰‡ä¸Šæ–¹ */
            z-index: 2; /* æ–‡å­—åœ¨å›¾ç‰‡ä¸Šå±‚ */
            font-size: 43px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 10px;
            margin-bottom: 20px; /* å¢åŠ æ ‡é¢˜å’ŒæŒ‰é’®ä¹‹é—´çš„é—´è· */
        }

        /* æŒ‰é’®å®¹å™¨ */
        .mode-button-container {
            position: absolute;
            height: 50px;
            width: 400px;
            z-index: 2;
            display: flex;
            gap: 30px;
            margin-top : 50px;
            margin-left: 150px;
        }

        #welcome-page #voice-mode-button,
        #welcome-page #text-mode-button {
            width: 100%;
            font-size: 26px;
            cursor: pointer;
            border-radius: 15px;
            background: linear-gradient(135deg, #6a8cff, #007bff); /* æµ…è“è‰²æ¸å˜ */
            border: none;
            color: white; /* æŒ‰é’®æ–‡å­—é¢œè‰² */
            transition: background 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
            text-align: center;
        }

        /* ä¾§è¾¹æ åŸºç¡€æ ·å¼ */
        #sidebar {
            position: relative;
            width: 250px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: width 0.1s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
            background-color: #f5f5f5;
            border-right: 1px solid #e0e0e0;
        }

        /* æŠ˜å çŠ¶æ€ */
        #sidebar.collapsed {
            width: 100px; /* æŠ˜å åçš„å®½åº¦ */
            overflow: hidden; /* éšè—å†…å®¹ */
            background-color: #f5f5f5;
            border-right: 1px solid #e0e0e0;
        }

        /* æŠ˜å æŒ‰é’®æ ·å¼ */
        #toggle-sidebar {
            align-self: flex-end; /* æŒ‰é’®é å³ */
            margin-bottom: 10px; /* è°ƒæ•´æŒ‰é’®ä½ç½® */
            font-size: 30px;
            background-color: #f5f5f5;
            border: none;
        }

        #toggle-sidebar:hover {
            background-color: #cfcfcf;
        }

        .sidebar-footer {
            position: relative;
            margin-top: auto; /* å°†å†…å®¹æ¨åˆ°æœ€åº•éƒ¨ */
            padding-top: 20px;
        }

        #settings-button {
            position: absolute;
            right: 10px;
            bottom: 5px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* è®¾ç½®æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000; /* ç¡®ä¿æ¨¡æ€çª—å£åœ¨æœ€ä¸Šå±‚ */
            justify-content: center;
            align-items: center;
        }


        .modal-content {
            width: 600px; /* è®¾ç½®å®½åº¦ */
            height: 480px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
            position: relative;
            overflow: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }

        .memory-model {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; /* ç¡®ä¿æ¨¡æ€çª—å£åœ¨æœ€ä¸Šå±‚ */
            justify-content: center;
            align-items: center;
        }

        .memory-content {
            width: 600px; /* è®¾ç½®å®½åº¦ */
            max-width: 80%;
            position: relative;
            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }

        #memory-button {
            padding: 10px;
            right: 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #add-memory-button
        {
            padding: 10px;
            background-color: #ffffff;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #add-memory-button:hover {
            background-color: #f0f0f0;
        }

        .add-memory-modal {
            display: none;
            position: fixed;  /* æ”¹ä¸ºå›ºå®šå®šä½ */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);  /* ç²¾å‡†å±…ä¸­ */
            width: 550px;  /* å›ºå®šå®½åº¦ */
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2001;
        }

        #add-memory-text {
            width: 500px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        #add-memory-send-button {
            display: block;
            width: 60px;
            padding: 8px;  /* å‡å°æŒ‰é’®å°ºå¯¸ */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;  /* è°ƒå°å­—ä½“ */
            transition: background 0.2s;
        }

        #add-memory-send-button:hover {
            background-color: #0056b3;  /* åŠ æ·±æ‚¬åœè‰² */
        }

        #memory-template {
            display: none;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        .memory-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .delete-memory-button {
            background: #f0f0f0;
            border: #007bff 1px solid;
            color: #dc3545;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            transition: opacity 0.2s;
        }

        .delete-memory-button:hover {
            opacity: 0.8;
        }

        .file-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; /* ç¡®ä¿æ¨¡æ€çª—å£åœ¨æœ€ä¸Šå±‚ */
            justify-content: center;
            align-items: center;
        }

        .file-content {
            width: 600px; /* è®¾ç½®å®½åº¦ */
            max-width: 80%;
            position: relative;
            overflow-y: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }

        #file-button {
            padding: 10px;
            right: 20px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .file-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .delete-file-button {
            background: #f0f0f0;
            border: #007bff 1px solid;
            color: #dc3545;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            transition: opacity 0.2s;
        }

        .form-group {
            margin: 10px;
            display: flex; /* å¯ç”¨ Flexbox å¸ƒå±€ */
            align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input[type="range"] {
            width: 150px;
            height: 15px;
            margin-left: auto; /* é å³å¯¹é½ */
        }

        #settings-form {
            height: calc(100% - 40px); /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */
            padding-bottom: 40px; /* ä¸ºæŒ‰é’®ç•™å‡ºè¶³å¤Ÿç©ºé—´ */
        }

        #settings-form button[type="submit"] {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            margin: 0;
        }

        /* ä¿å­˜æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #settings-form button[type="submit"]:hover {
            background-color: #0056b3; /* æ‚¬åœæ—¶èƒŒæ™¯é¢œè‰² */
        }

        /* å¼€å…³å®¹å™¨ */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* éšè—é»˜è®¤çš„ checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* æ»‘å— */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 25px;
            width: 50px;
            height: 25px;
        }

        /* æ»‘å—åœ†å½¢éƒ¨åˆ† */
        .slider:before {
            position: absolute;
            content: "";
            height: 21px;
            width: 21px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        /* å½“å¼€å…³æ‰“å¼€æ—¶çš„æ ·å¼ */
        input:checked + .slider {
            background-color: #2196F3; /* è“è‰² */
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        #new-chat-button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #new-chat-button:hover,
        #voice-mode-button:hover,
        #text-mode-button:hover {
            background-color: #0056b3;
        }

        #chat-history-container {
            background-color: #f0f0f0;
            margin-top: 20px;
            max-height: 170px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* è¶…å‡ºéƒ¨åˆ†æ»šåŠ¨ */
        }

        #chat-history-container::-webkit-scrollbar {
            width: 0; /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
            height: 0; /* éšè—çºµå‘æ»šåŠ¨æ¡ */
        }

        .chat-button {
            position: relative;
            display: flex;
            width: 100%;
            padding: 10px;
            border: none;
            background-color: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .chat-title {
            display: inline-block;
            width: calc(100% - 30px); /* ç•™å‡ºåˆ é™¤æŒ‰é’®çš„ç©ºé—´ */
            overflow: hidden;
            text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†ç”¨çœç•¥å·è¡¨ç¤º */
            white-space: nowrap; /* ä¸æ¢è¡Œ */
        }

        .delete-chat-button {
            position: absolute;
            right: 10px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            visibility: hidden;
        }

        .chat-button:hover {
            background-color: #cfcfcf;
        }

        .chat-button:hover .delete-chat-button {
            opacity: 1;
            visibility: visible;
        }

        .delete-chat-button:hover {
            transform: scale(1.2);
        }

        #live2d-container {
            position: absolute;
            bottom: 60px;
            width: 95%; /* è®¾ç½®å®½åº¦ */
            height: 400px; /* è®¾ç½®é«˜åº¦ */
            pointer-events: none; /* ç¦ç”¨é¼ æ ‡äº‹ä»¶ */
        }

        /* ä¸»åŒºåŸŸ */
        #chat-container {
            flex: 1;
            position: relative;
            /*padding: 10px 10px 80px;*/
            border: none;
            background-color: white;
        }
        /* éšè—æ»šåŠ¨æ¡ */
        #chat-container::-webkit-scrollbar {
            width: 0; /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
            height: 0; /* éšè—çºµå‘æ»šåŠ¨æ¡ */
        }

        #chat-content-container {

            top: 0;
            bottom: 0;
            position: relative;
            overflow-y: auto;
            background-color: white;
            border: none;
            max-width: 1000px; /* Ajustez cette valeur selon vos besoins */
            margin: 0 auto; /* Centre le conteneur horizontalement */
        }

        /* éšè—æ»šåŠ¨æ¡ */
        #chat-content-container::-webkit-scrollbar {
            width: 0; /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ */
            height: 0; /* éšè—çºµå‘æ»šåŠ¨æ¡ */
        }

        #scroll-to-bottom {
            z-index: 2;
            position: fixed;
            top: 80px; /* åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
            left: calc(50% + 100px);
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 123, 255, 0.8);
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        #scroll-to-bottom:hover {
            background: rgba(0, 86, 179, 0.9);
            transform: translateX(-50%) scale(1.1);
        }

        #scroll-to-bottom.visible {
            opacity: 1;
        }

        /* æ¯æ¡èŠå¤©è®°å½• */
        .chat-content {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: white;
        }

        .message.user-message {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .recognized-text {
            max-width: 80%;
            background-color: #e1f5fe;
            padding: 0 15px; /* ç¼©å°ä¸Šä¸‹ padding */
            border-radius: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
            margin: 0; /* ç§»é™¤é»˜è®¤å¤–è¾¹è· */
            display: inline-block; /* ç¡®ä¿è¡¨ç°ä¸€è‡´ */
        }

        /* AI æ¶ˆæ¯å®¹å™¨ */
        .message.ai-message {
            display: flex;
            align-items: flex-start;
            gap: 1px; /* å¤´åƒå’Œå†…å®¹ä¹‹é—´çš„é—´è· */
            margin-top: 10px;
            margin-bottom: 50px;
            position: relative; /* ä¸ºå­å…ƒç´ æä¾›å®šä½ä¸Šä¸‹æ–‡ */
            padding-bottom: 20px; /* ä¸ºæŒ‰é’®é¢„ç•™ç©ºé—´ï¼Œé¿å…å†…å®¹è¢«æŒ‰é’®é®æŒ¡ */
        }

        .bottom-button-container{
            height: 100px;
            background-color: #9a6e3a;
            display: flex !important;
            justify-content: left;
        }

        .copy-button {
            position: absolute; /* ç»å¯¹å®šä½ */
            bottom: 0; /* æ”¾åœ¨å®¹å™¨åº•éƒ¨ */
            left: 50px; /* æ”¾åœ¨å®¹å™¨å·¦ä¾§ */
            margin: 10px; /* æ ¹æ®éœ€è¦è°ƒæ•´é—´è· */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .copy-button:hover {
            background-color: #f0f0f0; /* é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
        }

        .copy-button {
            position: absolute; /* ç»å¯¹å®šä½ */
            bottom: 0; /* æ”¾åœ¨å®¹å™¨åº•éƒ¨ */
            left: 50px; /* æ”¾åœ¨å®¹å™¨å·¦ä¾§ */
            margin: 10px; /* æ ¹æ®éœ€è¦è°ƒæ•´é—´è· */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .copy-button:hover::after {
            content: "Copy";
            position: absolute;
            top: 120%; /* ä»æŒ‰é’®åº•éƒ¨å¼€å§‹ */
            left: 50%; /* æ°´å¹³å±…ä¸­ */
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */

            padding: 5px;
            background-color: rgba(0, 0, 0, 0.7); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            color: white; /* æ–‡å­—é¢œè‰² */
            border-radius: 8px; /* åœ†è§’ */
            opacity: 1; /* å®Œå…¨æ˜¾ç¤º */
            transition: opacity 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
            z-index: 10; /* ç¡®ä¿æ‚¬æµ®æ¡†åœ¨æœ€ä¸Šå±‚ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            font-size: 12px; /* æ–‡å­—å¤§å° */
        }

        .info-button {
            position: absolute; /* ç»å¯¹å®šä½ */
            bottom: 0; /* æ”¾åœ¨å®¹å™¨åº•éƒ¨ */
            left: 80px; /* æ”¾åœ¨å®¹å™¨å·¦ä¾§ */
            margin: 10px; /* æ ¹æ®éœ€è¦è°ƒæ•´é—´è· */
            display: none;
            border: none;
            background-color: #ffffff;
        }

        .info-button:hover {
            background-color: #f0f0f0; /* é¼ æ ‡æ‚¬åœæ—¶çš„èƒŒæ™¯è‰² */
        }

        .info-button:hover::after {
            content: attr(data-info); /* ä» data-info å±æ€§ä¸­è¯»å–å†…å®¹ */
            position: absolute;
            top: 120%; /* ä»æŒ‰é’®åº•éƒ¨å¼€å§‹ */
            left: 50%; /* æ°´å¹³å±…ä¸­ */
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
            width: 150px; /* æ‚¬æµ®æ¡†çš„å®½åº¦ */
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.7); /* é»‘è‰²åŠé€æ˜èƒŒæ™¯ */
            color: white; /* æ–‡å­—é¢œè‰² */
            border-radius: 8px; /* åœ†è§’ */
            opacity: 1; /* å®Œå…¨æ˜¾ç¤º */
            transition: opacity 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
            z-index: 10; /* ç¡®ä¿æ‚¬æµ®æ¡†åœ¨æœ€ä¸Šå±‚ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            font-size: 12px; /* æ–‡å­—å¤§å° */
            line-height: 1.5; /* è¡Œé«˜ */
        }

        .info-button::after {
            opacity: 0; /* é»˜è®¤éšè— */
            pointer-events: none; /* é˜²æ­¢ä¼ªå…ƒç´ å¹²æ‰°ç‚¹å‡»äº‹ä»¶ */
        }

        #copy-feedback {
            color: green;
            margin-top: 10px;
        }

        /* å¤´åƒå’Œåå­—çš„å®¹å™¨ */
        .ai-header {
            display: flex;
            flex-direction: column; /* ä¸Šä¸‹æ’åˆ— */
            align-items: flex-start; /* é å·¦å¯¹é½ */
        }

        /* AI å¤´åƒå®¹å™¨ */
        .profile-icon {
            width: 50px; /* å›ºå®šå®½åº¦ */
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
        }

        /* AI å¤´åƒ */
        .profile-icon img {
            width: 35px; /* å¤´åƒå¤§å° */
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .ai-name {
            font-size: 16px; /* æ–‡æœ¬å¤§å° */
            color: #333; /* æ–‡æœ¬é¢œè‰² */
            font-weight: bold; /* åŠ ç²— */
            margin-top: 10px
        }

        /* AI å›å¤å†…å®¹ */
        .ai-response {
            background-color: white;
            overflow-wrap: break-word; /* æ›´ç°ä»£çš„å±æ€§ */
            align-self: flex-end; /* å³å¯¹é½ */
            margin: 4px 0;
            padding: 2px 0;
            border-radius: 8px;
            line-height: 1.2;
        }

        /* èŠå¤©æ ‡é¢˜ */
        #chat-header-container {
            font-size: 28px;
            margin-bottom: 10px;
            padding: 10px;
        }

        #model-selector {
            width: 300px;
            padding: 10px;
            border : none;
        }

        /* è¯­éŸ³æŒ‰é’® */
        .button-container {
            position: fixed;
            bottom: 0;
            left: 60%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 10px;
            border-radius: 25px 25px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        /* æ–‡å­—è¾“å…¥æ¡† */
        #input-container {
            position: absolute;
            bottom: 20px;       /* ä¸çˆ¶çº§padding-bottomå¯¹åº” */
            left: 20px;         /* å¯¹é½çˆ¶çº§å·¦padding */
            right: 20px;        /* å¯¹é½çˆ¶çº§å³padding */
            display: flex;
            gap: 8px;
            background-color: aliceblue;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        #user-input {
            flex: 1; /* è¾“å…¥æ¡†å æ®å‰©ä½™ç©ºé—´ */
            height: 56px; /* åˆå§‹é«˜åº¦ */
            min-height: 56px !important;
            max-height: 150px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            padding: 15px; /* å¢åŠ å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§å­—ä½“ */
            border: 1px solid #ccc; /* è¾¹æ¡† */
            border-radius: 5px; /* åœ†è§’ */
            margin-right: 0; /* ä¸æŒ‰é’®çš„é—´è· */
            outline: none; /* ç§»é™¤é»˜è®¤èšç„¦è¾¹æ¡† */
            overflow-y: auto; /* è¶…å‡ºéƒ¨åˆ†æ»šåŠ¨ */
            line-height: 1.5;
        }

        .circle-button {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        #send-button,
        #upload-file-button,
        #toggle-mode-button,
        #shut-up-button,
        #shut-up-button2,
        #toggle-mode-audio-button {
            padding: 15px 30px; /* å¢åŠ æŒ‰é’®å†…è¾¹è· */
            font-size: 16px; /* å¢å¤§å­—ä½“ */
            background-color: #007bff; /* æŒ‰é’®èƒŒæ™¯è‰² */
            color: white; /* æŒ‰é’®æ–‡å­—é¢œè‰² */
            border: none; /* ç§»é™¤è¾¹æ¡† */
            border-radius: 5px; /* åœ†è§’ */
            cursor: pointer; /* é¼ æ ‡æŒ‡é’ˆæ ·å¼ */
            transition: background-color 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
        }

        #send-button:hover,
        #upload-file-button:hover,
        #toggle-mode-button:hover,
        #shut-up-button:hover,
        #shut-up-button2:hover,
        #toggle-mode-audio-button:hover {
            background-color: #0056b3; /* æ‚¬åœæ—¶èƒŒæ™¯è‰² */
        }

        /* ğŸ•¶ï¸ éšè—é»˜è®¤æ–‡ä»¶è¾“å…¥ */
        #file-input {
            display: none;
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        #start-button {
            width: 180px;
            height: 50px;
            border: none;
            border-radius: 25px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #start-button:hover {
            background-color: #0056b3;
        }

        #start-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

    </style>

</head>
<body>
    <script src="{{ url_for('prism', filename='prism.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- å·¦ä¾§è¾¹æ  -->
    <div id="sidebar">
        <!-- æŠ˜å æŒ‰é’® -->
        <button id="toggle-sidebar" class="cursor-pointer p-[7px] flex rounded-xl hover:bg-gray-100 dark:hover:bg-gray-900 transition">
            â‰¡
        </button>
        <div label="sidebar-content">
            <button id="new-chat-button">æ–°èŠå¤©</button>
        </div>
        <!-- èŠå¤©å†å²åˆ—è¡¨ -->
        <template id="chat-history-template">
            <span class="chat-button">
                <span class="chat-title">æ–°èŠå¤©</span>
                <span class="delete-chat-button">âŒ</span>
            </span>
        </template>
        <div id="chat-history-container"></div>
        <canvas id="live2d-container"></canvas>
        <div class="sidebar-footer">
            <button id="settings-button">âš™ï¸</button>
            <small>Â© 2025 ExSLM</small>
        </div>

        <!-- ä¿®æ”¹åçš„è®¾ç½®çª—å£ -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="settings-close-button close-button">&times;</span>

                <!-- å·¦ä¾§sidebar -->
                <div class="settings-sidebar">
                    <h2 style="padding-left: 20px">è®¾ç½®</h2>
                    <div class="settings-sidebar-item active" data-section="general">General Settings</div>
                    <div class="settings-sidebar-item" data-section="memory">è®°å¿†ç®¡ç†</div>
                    <div class="settings-sidebar-item" data-section="file">æ–‡ä»¶ç®¡ç†</div>
                </div>

                <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
                <div class="settings-content">
                    <!-- General Settings éƒ¨åˆ† -->
                    <div id="general-settings" class="settings-section active">
                        <h2>General Settings</h2>
                        <form id="settings-form">
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="language">è¯­éŸ³è¯­è¨€:</label>
                                <select id="language" name="language">
                                    <option value=0>Chinese</option>
                                    <option value=1>English</option>
                                    <option value=2>Japanese</option>
                                    <option value=3>French</option>
                                </select>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="temperature">Temperature:</label>
                                <input type="range" id="temperature" name="temperature" min="0.1" max="1" value="0.1" step="0.1">
                                <p><span id="temperatureValue">1.0</span></p>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="audio">ä½¿ç”¨éŸ³é¢‘:</label>
                                <label class="switch">
                                    <input type="checkbox" id="audio">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="use_RAG">ä½¿ç”¨RAGï¼ˆéœ€é‡æ–°åŠ è½½æ¨¡å‹ï¼‰:</label>
                                <label class="switch">
                                    <input type="checkbox" id="use_RAG">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="embedding_model">åµŒå…¥æ¨¡å‹ï¼ˆæ¯æ¬¡åˆ‡æ¢éœ€è¦åŠ è½½ï¼‰:</label>
                                <select id="embedding_model" name="embedding_model">
                                    <option value=0>BAAI/bge-reranker-base</option>
                                    <option value=1>BAAI/bge-large-en-v1.5</option>
                                    <option value=2>BAAI/bge-large-zh-v1.5</option>
                                    <option value=3>BAAI/bge-m3</option>
                                    <option value=4>Alibaba-NLP/gte-multilingual-base</option>
                                    <option value=5>ibm-granite/granite-embedding-278m-multilingual</option>
                                </select>
                            </div>
                            <button type="submit">ä¿å­˜</button>
                        </form>
                    </div>

                    <!-- è®°å¿†ç®¡ç†éƒ¨åˆ† -->
                    <div id="memory-settings" class="settings-section">
                        <h3>è®°å¿†ç®¡ç†</h3>
                        <button id="add-memory-button">æ·»åŠ è®°å¿†</button>
                        <div id="memories-container"></div>
                    </div>

                    <!-- æ–‡ä»¶ç®¡ç†éƒ¨åˆ† -->
                    <div id="file-settings" class="settings-section">
                        <h3>å·²ä¸Šä¼ æ–‡ä»¶</h3>
                        <div id="files-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <template id="memory-template">
            <div class="memory-item">
                <span class="memory-content"></span>
                <button class="delete-memory-button">åˆ é™¤</button>
            </div>
        </template>

        <div id="memory-window" class="memory-model">
            <div id="memory-modal-content" class="modal-content">
                <span class="close-button">&times;</span>
                <h3>è®°å¿†ç®¡ç†</h3>
                <button id="add-memory-button">æ·»åŠ è®°å¿†</button>
                <!-- æ·»åŠ è®°å¿†é¡¹å®¹å™¨ -->
                <div id="memories-container"></div>
            </div>
        </div>

        <div id="add-memory-window" class="add-memory-modal">
            <textarea
                id="add-memory-text"
                placeholder="è¯·è¾“å…¥è¦æ·»åŠ çš„è®°å¿†å†…å®¹..."
            ></textarea>
            <button id="add-memory-send-button">æ·»åŠ </button>
        </div>

        <!-- ç®¡ç†æ–‡ä»¶çª—å£ -->
        <template id="file-template">
            <div class="file-item">
                <span class="file-content"></span>
                <button class="delete-file-button">åˆ é™¤</button>
            </div>
        </template>

        <div id="file-window" class="file-modal">
            <div id="file-modal-content" class="modal-content">
                <span class="close-button">&times;</span>
                <h3>å·²ä¸Šä¼ æ–‡ä»¶</h3>
                <div id="files-container"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»å¯¹è¯ç•Œé¢ -->
    <div id="chat-container">

        <!-- æ¬¢è¿é¡µé¢ -->
        <div id="welcome-page">
            <!--<h1>æ¬¢è¿ä½¿ç”¨ExSLMæ™ºèƒ½æ•™å¸ˆåŠ©æ‰‹</h1>-->
            <img src="{{ url_for('static', filename='images/wel2.jpg') }}" alt="æ¬¢è¿èƒŒæ™¯å›¾">
            <div class="mode-button-container">
                <button id="voice-mode-button">è¯­éŸ³æ¨¡å¼</button>
                <button id="text-mode-button">æ–‡å­—æ¨¡å¼</button>
            </div>
        </div>

        <!-- è¯†åˆ«ç•Œé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="recognition-interface" style="display: none;">
            <div id="chat-header-container" style="display: flex;">
                <strong>ExSLM</strong>
                <select id="model-selector">
                    <option value="0" >anthropic.claude-3-5-sonnet-20240620-v1:0</option>
                    <option value="1">anthropic.claude-3-sonnet-20240229-v1:0</option>
                    <option value="2">meta.llama3-70b-instruct-v1</option>
                </select>
                <div id="embedding-model-state" style="font-size: medium; color: #666; text-align: right; margin-left: auto; display: block;"></div>
            </div>

            <!-- æ–‡å­—æ¨¡å¼å®¹å™¨ -->
            <div id="text-mode">
                <button id="scroll-to-bottom" onclick="smartScroll()">â†“</button>
                <div id="input-container">
                    <label for="user-input"></label><textarea id="user-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." ></textarea>
                    <div style="display: flex; gap: 8px; flex-shrink: 0;">
                        <button id="send-button" class="circle-button">â¤</button>
                        <button id="upload-file-button" class="circle-button" onclick="handleUpload()">âœ‰</button>
                        <button id="shut-up-button" class="circle-button">Â¶</button>
                        <button id="toggle-mode-button" class="circle-button">ï¸ğŸ™ï¸</button>
                    </div>
                </div>
                <input type="file" id="file-input" onchange="uploadFile()">
            </div>

            <!-- è¯­éŸ³æ¨¡å¼å®¹å™¨ -->
            <div id="voice-mode" style="display: none;">
                <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
                <div class="button-container">
                    <button id="start-button">ğŸ™ï¸ å¼€å§‹è¯­éŸ³è¾“å…¥</button>
                    <button id="upload-file-button" class="circle-button" onclick="handleUpload()">âœ‰</button>
                    <button id="shut-up-button2" class="circle-button">Â¶</button>
                    <button id="toggle-mode-audio-button" class="circle-button">ï¸ğŸ–Šï¸</button>
                </div>
            </div>

            <template id="chat-template">
                <div class="chat-content">
                    <div class="message user-message">
                        <p class="recognized-text">ç”¨æˆ·ï¼šç­‰å¾…è¾“å…¥...</p>
                    </div>
                    <div class="message ai-message">
                        <div class="profile-icon">
                                <img src="{{ url_for('static', filename='images/avatar.png')}}">
                            </div>
                        <div class="ai-header">
                            <span class="ai-name">ExSLM</span>
                            <div class="message-content">
                                <p class="ai-response">ç­‰å¾…ä¸­...</p>
                            </div>
                        </div>

                        <div class="bottom-button-container">
                            <button class="copy-button">ğŸ“‹</button>
                            <button class="info-button">â„¹ï¸</button>
                        </div>
                        <p id="copy-feedback" style="display: none;">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼</p>
                    </div>
                </div>
            </template>

            <div id="chat-content-container">

            </div>
        </div>
    </div>


    <!-- SocketIO é€šä¿¡ -->
    <script>
        var socket = io.connect("http://" + document.domain + ":" + location.port);

        MathJax.options.ignoreHtmlClass = 'scroll-lock';

        // è·å– DOM å…ƒç´ 
        const welcomePage = document.getElementById("welcome-page");
        const recognitionInterface = document.getElementById("recognition-interface");
        const voiceModeButton = document.getElementById("voice-mode-button");
        const textModeButton = document.getElementById("text-mode-button");
        const voiceMode = document.getElementById("voice-mode");
        const textMode = document.getElementById("text-mode");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");
        const inputContainer = document.getElementById("input-container");
        const settingsButton = document.getElementById('settings-button');
        const modal = document.getElementById('settings-modal');
        const memoryModal = document.getElementById('memory-window');
        const fileModal = document.getElementById('file-window');
        const closeButton = document.querySelector('#settings-modal .close-button');
        const memoryCloseButton = document.querySelector('#memory-window .close-button');
        const fileCloseButton = document.querySelector('#file-window .close-button');
        welcomePage.style.backgroundImage = "url('{{ url_for('static', filename='images/welcome-bg.jpg') }}')";
        const audioToggle = document.getElementById('audio');
        let outputting, interrupted;
        const language = document.getElementById('language');
        const chatContainer = document.getElementById('chat-content-container');
        const modelSelector = document.getElementById('model-selector');
        let currentChat = []; // å½“å‰èŠå¤©è®°å½•
        const memoryButton = document.getElementById('memory-button');
        const addMemoryButton = document.getElementById('add-memory-button');
        const fileButton = document.getElementById('file-button');
        const addFileButton = document.getElementById('add-File-button');
        const newChatButton = document.getElementById('new-chat-button');
        const chatHistoryContainer = document.getElementById('chat-history-container');
        const toggleModeButton = document.getElementById('toggle-mode-button');
        const toggleModeAudioButton = document.getElementById('toggle-mode-audio-button');
        const shutUpButton = document.getElementById('shut-up-button');
        const shutUpButton2 = document.getElementById('shut-up-button2');
        let model;

        // åˆå§‹åŒ–è®¾ç½®
        socket.emit('start_settings_init');
        socket.emit('clear_uploads');
        socket.emit('global_memory_init');
        socket.emit('chat_list_init');

        Window.PIXI = PIXI
        console.log("åŠ è½½å‡ºäº†å—ï¼Ÿ", PIXI.live2d);
        async function loadModel() {
            try {
                // åˆ›å»º PIXI åº”ç”¨
                const app = new PIXI.Application({
                    view: document.getElementById('live2d-container'),
                    autoStart: true,
                    resizeTo: window,
                    backgroundColor: 0xf5f5f5
                });

                // åŠ è½½ Live2D æ¨¡å‹
                console.log("cecece", PIXI.live2d.Live2DModel)
                model = await PIXI.live2d.Live2DModel.from("{{ url_for('static', filename='model/model40/openSource/openSource.model3.json') }}");
                console.log("Live2D Model loaded:", model);

                // å°†æ¨¡å‹æ·»åŠ åˆ°èˆå°
                app.stage.addChild(model);

                // è°ƒæ•´æ¨¡å‹çš„ä½ç½®ã€ç¼©æ”¾ç­‰
                model.x = -350; // æ ¹æ®éœ€è¦è°ƒæ•´ä½ç½®
                model.y = -120;
                //model.scale.set(10000, 10000); // æ ¹æ®éœ€è¦è°ƒæ•´ç¼©æ”¾
                model.scale.set(0.5, 0.15); // å‰è€…æ˜¯xè½´ç¼©æ”¾ï¼Œåè€…æ˜¯yè½´ç¼©æ”¾

                console.log("Model is ready to use:", model);

            } catch (error) {
                console.error("Failed to load Live2D model:", error);
            }

            console.log("Mouth Open")
        }

        // è°ƒç”¨ loadModel å‡½æ•°
        loadModel();

        socket.on("settings_init", (data) => {
            // åˆå§‹åŒ–è®¾ç½®
            const temperature = data.temperature;
            const audio_state = data.audio;
            const lang = data.language;
            const embedding_model = data.embedding_model;
            const use_RAG = data.use_RAG;
            document.getElementById('temperature').value = temperature;
            document.getElementById('temperatureValue').textContent = temperature;
            audioToggle.checked = audio_state;
            document.getElementById('use_RAG').checked = use_RAG;
            document.getElementById('embedding_model').value = embedding_model;
            language.value = lang;

            socket.emit('RAG_refresh');
        });

        // è®¾ç½®çª—å£æ¨¡æ€åˆ‡æ¢
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–sidebaré¡¹å’Œå†…å®¹åŒºåŸŸ
            const sidebarItems = document.querySelectorAll('.settings-sidebar-item');
            const sections = document.querySelectorAll('.settings-section');

            // ç‚¹å‡»sidebaré¡¹åˆ‡æ¢æ˜¾ç¤ºå†…å®¹
            sidebarItems.forEach(item => {
                item.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));

                    // æ·»åŠ activeç±»åˆ°å½“å‰é¡¹
                    this.classList.add('active');
                    const sectionId = this.dataset.section + '-settings';
                    document.getElementById(sectionId).classList.add('active');
                });
            });

            // ä¿®æ”¹è®°å¿†å’Œæ–‡ä»¶æŒ‰é’®çš„è¡Œä¸º
            document.getElementById('memory-button').addEventListener('click', function() {
                // æ˜¾ç¤ºè®¾ç½®çª—å£å¹¶æ¿€æ´»è®°å¿†ç®¡ç†éƒ¨åˆ†
                document.getElementById('settings-modal').style.display = 'flex';
                sidebarItems.forEach(i => i.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                document.querySelector('.settings-sidebar-item[data-section="memory"]').classList.add('active');
                document.getElementById('memory-settings').classList.add('active');
            });

            document.getElementById('file-button').addEventListener('click', function() {
                // æ˜¾ç¤ºè®¾ç½®çª—å£å¹¶æ¿€æ´»æ–‡ä»¶ç®¡ç†éƒ¨åˆ†
                document.getElementById('settings-modal').style.display = 'flex';
                sidebarItems.forEach(i => i.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                document.querySelector('.settings-sidebar-item[data-section="file"]').classList.add('active');
                document.getElementById('file-settings').classList.add('active');
            });

        });

        // æ–‡ä»¶ç®¡ç†æ¨¡å—
        socket.on('upload_files', (data) => {
                // è¯»å– doc_list
                const docList = data.doc_list;
                console.log("Received doc_list:", docList);

                if (docList.length > 5){
                    alert("è¶…å‡ºå¯ä¸Šä¼ æ–‡ä»¶ä¸Šé™ï¼Œä»…ä¿ç•™æœ€è¿‘äº”åˆ™ï¼å¦‚éœ€å–æ¶ˆä¸Šä¼ ï¼Œè¯·å‰å¾€ è®¾ç½®-ç®¡ç†æ–‡ä»¶ åˆ é™¤ç›¸åº”æ–‡ä»¶ã€‚");
                }

                // è¯»å– using_doc_list
                const usingDocList = data.using_doc_list;
                console.log("Received using_doc_list:", usingDocList);

                const filesContainer = document.getElementById("files-container");
                // æ¸…ç©ºç°æœ‰å†…å®¹é¿å…é‡å¤
                filesContainer.innerHTML = '';

                // å¤„ç†åˆ—è¡¨å†…å®¹
                docList.forEach((fileName, index) => {
                    console.log(`Document ${index + 1}: ${fileName}`);
                    const fileTemplate = document.getElementById("file-template").content.cloneNode(true);
                    const deleteButton = fileTemplate.querySelector(".delete-file-button");
                    const fileItem = fileTemplate.querySelector(".file-content");

                    // æ˜¾ç¤ºç´¢å¼•å’Œå†…å®¹
                    fileItem.innerHTML = `[${index + 1}] ${fileName}`;

                    // ä¸ºåˆ é™¤æŒ‰é’®ç»‘å®šç´¢å¼•
                    deleteButton.dataset.index = index; // å­˜å‚¨åŸå§‹ç´¢å¼•
                    console.log(deleteButton.dataset.index);
                    deleteButton.onclick = function() {
                        socket.emit("remove_file", this.dataset.index);
                    };

                    filesContainer.appendChild(fileTemplate);
                });

                usingDocList.forEach((fileName, index) => {
                    console.log(`Using Document ${index + 1}: ${fileName}`);
                })

            });

        // è®°å¿†ç®¡ç†æ¨¡å—
        socket.on("global_memory_refresh", (memoriesArray) => {
                const memoriesContainer = document.getElementById("memories-container");
                // æ¸…ç©ºç°æœ‰å†…å®¹é¿å…é‡å¤
                memoriesContainer.innerHTML = '';

                console.log(memoriesArray);

                // éå†æ‰€æœ‰è®°å¿†æ¡ç›®
                memoriesArray.forEach(memoryObj => {
                    const memoryTemplate = document.getElementById("memory-template").content.cloneNode(true);
                    const deleteButton = memoryTemplate.querySelector(".delete-memory-button");
                    const memoryItem = memoryTemplate.querySelector(".memory-content");

                    // æ˜¾ç¤ºç´¢å¼•å’Œå†…å®¹ï¼ˆå‡è®¾memoryObj.memoriesæ˜¯å­—ç¬¦ä¸²ï¼‰
                    memoryItem.innerHTML = `[${memoryObj.index + 1}] ${memoryObj.memory}`;

                    // ä¸ºåˆ é™¤æŒ‰é’®ç»‘å®šç´¢å¼•
                    deleteButton.dataset.index = memoryObj.index; // å­˜å‚¨åŸå§‹ç´¢å¼•
                    deleteButton.onclick = function() {
                        socket.emit("remove_memory", this.dataset.index);
                    };

                    memoriesContainer.appendChild(memoryTemplate);
                });
            });

        // æ·»åŠ è®°å¿†
        addMemoryButton.addEventListener('click', () => {
                const addMemoryWindow = document.getElementById('add-memory-window');
                addMemoryWindow.style.display = 'flex';
            });
        const addMemorySendButton = document.getElementById('add-memory-send-button');
        const addMemoryText = document.getElementById('add-memory-text');
        addMemorySendButton.addEventListener('click', () => {
            const memoryText = addMemoryText.value.trim();
            if (memoryText) {
                socket.emit("add_memory", memoryText);
                addMemoryText.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                const addMemoryWindow = document.getElementById('add-memory-window');
                addMemoryWindow.style.display = 'none';
            }
        });

        // ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
        document.getElementById('toggle-sidebar').addEventListener('click', function () {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed'); // åˆ‡æ¢æŠ˜å çŠ¶æ€

            if (sidebar.classList.contains('collapsed')) {
                newChatButton.innerHTML = 'ğŸ’¬'
                chatHistoryContainer.style.display = 'None';

                settingsButton.style.display = 'none';
            } else {
                // ç­‰å¾…0.5ç§’
                setTimeout(() => {
                    newChatButton.innerHTML = 'æ–°èŠå¤©'
                    settingsButton.style.display = 'block';
                    chatHistoryContainer.style.display = 'block';
                }, 50);
            }
        });

        // é¦–é¡µæŒ‰é’®
        socket.on("back_to_home", () => {
            welcomePage.style.display = "block";        // æ˜¾ç¤ºæ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "none"; // éšè—è¯†åˆ«ç•Œé¢
            voiceMode.style.display = "none";         // éšè—è¯­éŸ³æ¨¡å¼
            textMode.style.display = "none";           // éšè—æ–‡å­—æ¨¡å¼
            welcomePage.style.cssText = "";             // æ¸…é™¤å†…è”æ ·å¼
            welcomePage.classList.remove("modified-class"); // ç§»é™¤å¯èƒ½ä¿®æ”¹çš„ç±»
            welcomePage.classList.add("initial-class"); // æ·»åŠ åˆå§‹ç±»
        });

        // çª—å£å¤§å°åŠ¨æ€è°ƒæ•´
        // åŠ¨æ€è®¾ç½®é«˜åº¦çš„å‡½æ•°
        function setChatHeight() {
            const viewportHeight = window.innerHeight;
            chatContainer.style.height = `${viewportHeight - 180}px`;
        }

        // åˆå§‹åŒ–è®¾ç½®
        document.addEventListener('DOMContentLoaded', setChatHeight);

        // å…¼å®¹ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡º
        window.addEventListener('orientationchange', setChatHeight);

        function adjustWidth() {
            // å®æ—¶è®¡ç®—å®½åº¦
            const containerWidth = chatContainer.offsetWidth;
            inputContainer.style.width = `${containerWidth - 500}px`;
        }

        // åˆå§‹åŒ–æ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', adjustWidth);
        // çª—å£å˜åŒ–ç›‘å¬
        window.addEventListener('resize', () => {
            // é˜²æŠ–å¤„ç†ï¼ˆ500msé—´éš”ï¼‰
            clearTimeout(window.resizeTimer);
            ScrollManager.adjustButtonPosition();
            // requestAnimationFrame(adjustWidth);
            window.resizeTimer = setTimeout(setChatHeight, 500);

        });

        // é€‰æ‹©æ¨¡å‹
        document.getElementById('model-selector').addEventListener('change', () => {
            const currentModel = modelSelector.value;
            socket.emit('current_model_index', currentModel);
            console.log(currentModel);
        })

        // RAGçŠ¶æ€
        const ragState = document.getElementById('embedding-model-state');
        socket.on("RAG_loading", () => {
            ragState.textContent = `RAG æ­£åœ¨åŠ è½½ä¸­...`;
        });

        socket.on("RAG_loaded", () => {
            ragState.textContent = `RAG å·²å°±ç»ª`;
        });

        socket.on("RAG_loading_failed", (e) => {
            ragState.textContent = `RAG åŠ è½½å¤±è´¥: ${e}`;
        });

        socket.on("RAG_unavailable", () => {
            ragState.textContent = `RAG æœªå¼€å¯`;
        });

        // è®¾ç½®çª—å£
        document.addEventListener('DOMContentLoaded', function() {

            // æ‰“å¼€æ¨¡æ€çª—å£çš„å‡½æ•°
            function openModal() {
                modal.style.display = 'flex';
            }

            // å…³é—­æ¨¡æ€çª—å£çš„å‡½æ•°
            function closeModal() {
                modal.style.display = 'none';
            }

            // ç‚¹å‡»è®¾ç½®æŒ‰é’®æ‰“å¼€æ¨¡æ€çª—å£
            settingsButton.addEventListener('click', openModal);

            // ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­æ¨¡æ€çª—å£
            closeButton.addEventListener('click', function(e) {
                e.preventDefault();
                // console.log('Event details:', e);
                closeModal();
            });

            // ç›‘å¬æ»‘åŠ¨æ¡è¡Œä¸ºå¹¶æ›´æ–°æ˜¾ç¤ºçš„æ¸©åº¦å€¼
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperatureValue');
            temperatureSlider.addEventListener('input', () => {
                temperatureValue.textContent = temperatureSlider.value;
            });

            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('è®¾ç½®å·²ä¿å­˜')
                // å‘åç«¯å‘é€è®¾ç½®
                const temperature = temperatureSlider.value;
                const use_RAG = document.getElementById('use_RAG').checked;
                const embedding_model = document.getElementById('embedding_model').value;
                const state = audioToggle.checked;
                const lang = language.value;
                socket.emit('update_settings', { temperature: temperature, audio_state: state, language: lang, use_RAG: use_RAG, embedding_model: embedding_model });

                socket.emit('RAG_refresh');
                closeModal();
            });

            // ç›‘å¬åç«¯è¿”å›çš„ä¿å­˜æˆåŠŸäº‹ä»¶
            socket.on('temperature-saved', (data) => {
                console.log('Temperature saved:', data);
            });
        });

        // åˆ é™¤èŠå¤©è®°å½•ï¼Œæ¢å¤çª—å£
        socket.on("new_chat_window", () => {
            chatContainer.innerHTML = '';
        });

        // åˆ·æ–°èŠå¤©æ 
        socket.on("refresh_chat_list", (data) => {
            chatHistoryContainer.innerHTML = '';

            data.forEach((item) => {
                const chatTemplate = document.getElementById("chat-history-template").content.cloneNode(true);
                const chatButton = chatTemplate.querySelector(".chat-button");
                const chatTitle = chatTemplate.querySelector(".chat-title");
                const deleteButton = chatTemplate.querySelector(".delete-chat-button");

                // è®¾ç½®èŠå¤©æ ‡é¢˜å’Œåˆ é™¤æŒ‰é’®
                deleteButton.dataset.index = item.index; // å­˜å‚¨åŸå§‹ç´¢å¼•
                chatButton.dataset.index = item.index;
                deleteButton.onclick = function() {
                    socket.emit("delete_chat", this.dataset.index);
                };

                chatTitle.textContent = `èŠå¤© ${item.index + 1}`;

                // ç‚¹å‡»èŠå¤©æŒ‰é’®åŠ è½½èŠå¤©è®°å½•
                chatButton.onclick = function() {
                    socket.emit("choose_chat", this.dataset.index);
                    welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
                    recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
                    voiceMode.style.display = "none";         // éšè—è¯­éŸ³æ¨¡å¼
                    textMode.style.display = "block";          // æ˜¾ç¤ºæ–‡å­—æ¨¡å¼
                };

                if (item.stress === true)
                    chatButton.style.backgroundColor = "#f0f0f0";

                chatHistoryContainer.appendChild(chatTemplate);
            });
        });

        // æ–°èŠå¤©
        newChatButton.addEventListener("click", () => {
            textarea.style.height = '57px'; // åˆå§‹é«˜åº¦
            welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
            textMode.style.display = "block";          // æ˜¾ç¤ºæ–‡å­—æ¨¡å¼
            voiceMode.style.display = "none";          // éšè—è¯­éŸ³æ¨¡å¼
            socket.emit("new_chat"); // æ–°èŠå¤©
        });

        // è¯­éŸ³æ¨¡å¼
        voiceModeButton.addEventListener("click", () => {
            welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
            voiceMode.style.display = "block";         // æ˜¾ç¤ºè¯­éŸ³æ¨¡å¼
            textMode.style.display = "none";           // éšè—æ–‡å­—æ¨¡å¼
            socket.emit("new_chat"); // æ–°èŠå¤©
        });

        // æ–‡å­—æ¨¡å¼
        textModeButton.addEventListener("click", () => {
            textarea.style.height = '57px'; // åˆå§‹é«˜åº¦
            welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
            textMode.style.display = "block";          // æ˜¾ç¤ºæ–‡å­—æ¨¡å¼
            voiceMode.style.display = "none";          // éšè—è¯­éŸ³æ¨¡å¼
            socket.emit("new_chat"); // æ–°èŠå¤©
        });

        toggleModeButton.addEventListener("click", () => {
            welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
            voiceMode.style.display = "block";         // æ˜¾ç¤ºè¯­éŸ³æ¨¡å¼
            textMode.style.display = "none";           // éšè—æ–‡å­—æ¨¡å¼
        });

        toggleModeAudioButton.addEventListener("click", () => {
            textarea.style.height = '57px'; // åˆå§‹é«˜åº¦
            welcomePage.style.display = "none";        // éšè—æ¬¢è¿é¡µé¢
            recognitionInterface.style.display = "block"; // æ˜¾ç¤ºè¯†åˆ«ç•Œé¢
            textMode.style.display = "block";          // æ˜¾ç¤ºæ–‡å­—æ¨¡å¼
            voiceMode.style.display = "none";          // éšè—è¯­éŸ³æ¨¡å¼
        });

        // æ–‡æœ¬æ¡†å¤§å°è‡ªåŠ¨è°ƒæ•´é€»è¾‘
        const textarea = document.getElementById("user-input");
        textarea.addEventListener('input', function() {
            // é‡ç½®é«˜åº¦ï¼Œä½¿å¾—textareaå¯ä»¥ç¼©å°
			this.style.height = '40px';
			// æ ¹æ®å†…å®¹é‡æ–°è°ƒæ•´é«˜åº¦
            console.log(this.scrollHeight);
			this.style.height = this.scrollHeight + 3 + 'px';
        });

        // å‘é€æŒ‰é’®çš„çŠ¶æ€åˆ‡æ¢
        const sendButtonToggle = {
            "to_send": () => {
                sendButton.innerHTML = "â¤";
            },

            "to_interrupt": () => {
                sendButton.innerHTML = "â– ";
            }
        }

        // å‘é€æŒ‰é’®çš„åŠŸèƒ½
        const sendButtonActions = {
            "send": () => {
                const text = userInput.value.trim();
                if (text) {
                    socket.emit("user_text", text); // å‘é€ç”¨æˆ·è¾“å…¥åˆ°åç«¯
                    userInput.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
                    const textarea = document.getElementById("user-input");
                    textarea.style.height = '56.8px'; // é‡ç½®é«˜åº¦
                    sendButtonToggle["to_interrupt"](); // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
                    outputting = true; // è®¾ç½®è¾“å‡ºçŠ¶æ€

                    // ä¿å­˜ç”¨æˆ·è¾“å…¥åˆ°å½“å‰èŠå¤©è®°å½•
                    currentChat.push({ user: text, ai: "" }); // AI å›å¤æš‚æ—¶ä¸ºç©º
                }
            },

            "interrupt": () => {
                interrupted = true;
                socket.emit("interrupt"); // å‘é€ä¸­æ–­ä¿¡å·
                sendButtonToggle["to_send"](); // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            }
        }

        // å‘é€ç”¨æˆ·è¾“å…¥åˆ°åç«¯æˆ–æ‰§è¡Œä¸­æ–­è¾“å‡º
        sendButton.addEventListener("click", () => {
            if (outputting) {
                sendButtonActions["interrupt"]();
            } else {
                sendButtonActions["send"]();
            }
        });

        // å‘é€æŒ‰é’®çš„ENTERè§¦å‘
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !outputting) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤æ¢è¡Œ
                document.getElementById('send-button').click(); // è§¦å‘æŒ‰é’®ç‚¹å‡»
            }
        });

        // ç›‘å¬è¯­éŸ³è¯†åˆ«ç»“æœ
        socket.on("recognized_text", (text) => {
            const chatContainer = document.getElementById("chat-content-container");
            const chatTemplate = document.getElementById("chat-template").content.cloneNode(true);
            chatTemplate.querySelector(".recognized-text").innerHTML = `${text}`;
            chatContainer.appendChild(chatTemplate);
            Prism.highlightAll();
            MathJax.typeset();
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // éšè—çš„æäº¤æ–‡ä»¶æŒ‰é’®
        function handleUpload() {
            // ğŸ¯ è§¦å‘éšè—çš„æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            document.getElementById('file-input').click();
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) return;

            // ğŸ“¦ åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', file);

            try {
                // ğŸš€ ä½¿ç”¨Fetch APIå¼‚æ­¥ä¸Šä¼ 
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                // ğŸ”„ æ¸…ç©ºå·²é€‰æ–‡ä»¶
                fileInput.value = '';
            } catch (error) {
                alert('âŒ ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        // æµå¼æ¥æ”¶AIå›å¤ (ä½¿ç”¨æ–°äº‹ä»¶åç§°)
        let isNewResponse = true; // æ ‡è®°æ˜¯å¦æ–°å›å¤å¼€å§‹
        socket.on("refresh_ai_response", (responseHtml) => {
            if (interrupted) return;
            const chatContainer = document.getElementById("chat-content-container");
            // è·å–æœ€æ–°å¯¹è¯å—
            const lastChat = chatContainer.lastElementChild;
            const aiResponseElem = lastChat.querySelector(".ai-response");

            // å¢é‡æ›´æ–°å†…å®¹ ğŸš€
            aiResponseElem.innerHTML = `${responseHtml}`;

            // åŠ¨æ€é«˜äº® & æ•°å­¦æ¸²æŸ“ ğŸ’¡
            Prism.highlightAllUnder(lastChat); // ä»…å¤„ç†å½“å‰å—
            MathJax.typeset([aiResponseElem]); // ä»…æ¸²æŸ“å½“å‰å…ƒç´ 

            ScrollManager.autoScroll();
            ScrollManager.checkButtonVisibility();
        });

        document.addEventListener('click', function (event) {
            if (event.target.className === "copy-button") {
                const aiResponse = event.target.getAttribute('data-ai-response');
                if (aiResponse) {
                    console.log("ç‚¹å‡»å¤åˆ¶æŒ‰é’®ï¼Œå¤åˆ¶çš„æ–‡æœ¬:", aiResponse);
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(aiResponse)
                            .then(() => {
                                console.log("å¤åˆ¶æˆåŠŸ");
                                showFeedback();
                                alert('å¤åˆ¶æˆåŠŸï¼');
                            })
                            .catch((err) => {
                                console.error('å¤åˆ¶å¤±è´¥:', err);
                            });
                    } else {
                        fallbackCopy(aiResponse);
                    }
                } else {
                    console.error("æœªæ‰¾åˆ° AI å›å¤å†…å®¹");
                }
            }
        });

        socket.on("retrievedInfo", (infoData) => {
            const stopReason = infoData.stopReason;
            const stopSequence = infoData.stopSequence;
            const outputTokens = infoData.outputTokens;
            console.log(stopSequence, stopSequence, outputTokens);

            // è·å– infoButton
            const infoButtons = document.getElementsByClassName("info-button");
            const infoButton = infoButtons[infoButtons.length - 1];

            // å°†æ•°æ®å†™å…¥ infoButton çš„ data-info å±æ€§
            infoButton.setAttribute(
                "data-info",
                `Stop Reason: ${stopReason}\nStop Sequence: ${stopSequence}\nOutput Tokens: ${outputTokens}`
            );
            console.log(infoButton.attributes);
        });

        socket.on("ai_response_end", (aiResponse) => {
            interrupted = false;
            outputting = false; // é‡ç½®è¾“å‡ºçŠ¶æ€
            socket.emit("audio_completed");
            sendButtonToggle["to_send"](); // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            const copyButtons = document.getElementsByClassName("copy-button")
            const copyButton = copyButtons[copyButtons.length - 1]
            const infoButtons = document.getElementsByClassName("info-button")
            const infoButton = infoButtons[infoButtons.length - 1]
            console.log(copyButton); // æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–å…ƒç´ 
            copyButton.style.display = 'block'
            infoButton.style.display = 'block';

            // æ‰¾åˆ°æœ€æ–°çš„å¤åˆ¶æŒ‰é’®ï¼Œå¹¶å°† aiResponse å­˜å‚¨åˆ°å…¶ data å±æ€§ä¸­
            if (copyButton) {
                copyButton.setAttribute('data-ai-response', aiResponse);
            } else {
                console.error("æœªæ‰¾åˆ°æœ€æ–°çš„å¤åˆ¶æŒ‰é’®");
            }

            // ä¿å­˜å®Œæ•´çš„ AI å›å¤åˆ°å½“å‰èŠå¤©è®°å½•
            if (currentChat.length > 0) {
                const lastMessage = currentChat[currentChat.length - 1];
                if (lastMessage.ai === "") {
                    lastMessage.ai = aiResponse; // æ›´æ–° AI å›å¤
                } else {
                    currentChat.push({ user: "", ai: aiResponse }); // æ–°å¢ä¸€æ¡è®°å½•
                }
            }
        });

        // ç›‘å¬ç”Ÿæˆå¼€å§‹äº‹ä»¶ âš¡
        socket.on("begin_generate_response", () => {
            isNewResponse = true; // é‡ç½®æ ‡è®°
        });

        // ç»¼åˆæ»šåŠ¨æ§åˆ¶æ¨¡å— (v2.0)
        const scrollButton = document.getElementById('scroll-to-bottom');
        let autoScroll = true;
        let isProcessing = false;

        // æ™ºèƒ½æ»šåŠ¨ç³»ç»Ÿ ğŸŒŸ
        const ScrollManager = {
            threshold: 70, // æ»šåŠ¨åˆ°åº•éƒ¨çš„é˜ˆå€¼
            debounceTime: 500, // é˜²æŠ–æ—¶é—´

            init() {
                this.setupObservers();
                this.setupEventListeners();
                this.checkButtonVisibility();
            },

            setupObservers() {
                // å†…å®¹å˜åŒ–è§‚å¯Ÿè€…
                new MutationObserver(mutations => {
                    if (!isProcessing) this.autoScroll();
                }).observe(chatContainer, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            },

            setupEventListeners() {
                // æ•´åˆçš„æ»šåŠ¨äº‹ä»¶ç›‘å¬
                let scrollTimeout;
                chatContainer.addEventListener('scroll', () => {
                    document.body.classList.add('scroll-lock');

                    this.scrollTimer = setTimeout(() => {
                        document.body.classList.remove('scroll-lock');
                    }, 500);

                    clearTimeout(scrollTimeout);
                    isProcessing = true;

                    // åˆ¤æ–­æ»šåŠ¨ä½ç½®
                    const atBottom = this.isAtBottom();
                    autoScroll = atBottom;

                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.checkButtonVisibility(atBottom);

                    scrollTimeout = setTimeout(() => {
                        isProcessing = false;
                        if (autoScroll) this.autoScroll();
                    }, this.debounceTime);
                });

                // çª—å£å¤§å°å˜åŒ–å“åº”
                window.addEventListener('resize', () => {
                    if (autoScroll) this.forceScroll();
                });
            },

            autoScroll() {
                if (autoScroll && this.isAtBottom()) {
                    requestAnimationFrame(() => {
                        chatContainer.scrollTo({
                            top: chatContainer.scrollHeight,
                            behavior: 'smooth'
                        });
                    });
                }
            },

            forceScroll() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },

            isAtBottom() {
                return chatContainer.scrollHeight - chatContainer.scrollTop <=
                       chatContainer.clientHeight + this.threshold;
            },

            checkButtonVisibility(atBottom) {
                const shouldShow = atBottom === undefined ?
                    !this.isAtBottom() : !atBottom;

                const buttonVisible = shouldShow &&
                    (chatContainer.scrollHeight > chatContainer.clientHeight);
                scrollButton.style.opacity = buttonVisible ? '0.6' : '0';
                scrollButton.style.pointerEvents = buttonVisible ? 'auto' : 'none';
            },

            smartScroll() {
                autoScroll = true;
                this.forceScroll();
                this.checkButtonVisibility();
            },

            adjustButtonPosition() {
                const containerRect = chatContainer.getBoundingClientRect();
                const buttonBottom = containerRect.bottom - 20; // è·ç¦»åº•éƒ¨20px
                scrollButton.style.bottom = `${buttonBottom - containerRect.top}px`;
}
        };

        // åˆå§‹åŒ–æ»šåŠ¨ç³»ç»Ÿ
        ScrollManager.init();

        // æ»šåŠ¨æŒ‰é’®ç‚¹å‡»å¤„ç†
        scrollButton.addEventListener('click', () => ScrollManager.smartScroll());

        // ç›‘å¬åç«¯äº‹ä»¶
        socket.on('toggle_button', (data) => {
            toggleButton(data.button_id, data.state);
        });

        // å‘é€å¼€å§‹è¯­éŸ³æŒ‡ä»¤
        document.getElementById("start-button").onclick = function () {
            socket.emit("start_recognition");
        };

        // åˆ‡æ¢æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
        function toggleButton(buttonId, state) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = state;
            }
        }

        // ğŸ“¦ åˆ›å»ºéŸ³é¢‘é˜Ÿåˆ—å’Œæ’­æ”¾çŠ¶æ€æ ‡è¯†
        let audioQueue = [];
        let isPlaying = false;

        // ğŸ§ éŸ³é¢‘æ’­æ”¾å¤„ç†å™¨å‡½æ•°
        async function handleAudioPlayback(audioUrl) {
            // 1ï¸âƒ£ åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
            model.speak(audioUrl, {crossOrigin: "anonymous", overrideMotion: true,
            onFinish: () => {
                console.log("Voiceline is over");
                isPlaying = false;
                // ç­‰å¾…10ms
                setTimeout(() => {
                    playNext();
                }, 10);
            },
            onError: (err) => {console.log("Error: "+err)} })
            isPlaying = true;
            console.log("å¼€å§‹æ’­æ”¾ï¼š", audioUrl);
        }

        // â¡ï¸ æ’­æ”¾ä¸‹ä¸€ä¸ªéŸ³é¢‘çš„å‡½æ•°
        async function playNext() {
            if (audioQueue.length > 0 && !isPlaying) {
                const nextUrl = audioQueue.shift(); // ğŸšï¸ å–å‡ºé˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ 
                await handleAudioPlayback(nextUrl);
            }
        }

        // ä¸­æ–­2dæ¨¡å‹è¯­éŸ³
        shutUpButton.addEventListener("click", () => {
            model.stopSpeaking();
            isPlaying = false;
        });

        // ä¸­æ–­2dæ¨¡å‹è¯­éŸ³
        shutUpButton2.addEventListener("click", () => {
            model.stopSpeaking();
            isPlaying = false;
        });

        // è¯­éŸ³æ¨¡å¼ï¼Œæµå¼è¾“å‡ºéŸ³é¢‘å’Œæ–‡å­—
        socket.on("ai_response_audio", (audioUrl) => {
            // ğŸ“¥ å°†æ–°éŸ³é¢‘åŠ å…¥é˜Ÿåˆ—
            audioQueue.push(audioUrl);

            // ğŸš¦ å¦‚æœæ²¡æœ‰æ­£åœ¨æ’­æ”¾ï¼Œç«‹å³å¼€å§‹æ’­æ”¾
            if (!isPlaying) {
                playNext();
            }
        });

        console.log("copy-button æ•°é‡:", document.querySelectorAll(".copy-button").length);

    </script>
</body>
</html>